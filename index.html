<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Reminder</title>
    <!-- Tailwind CSS - CDN version (production warning suppressed) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning
        window.addEventListener('DOMContentLoaded', function() {
            const originalWarn = console.warn;
            console.warn = function(message) {
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, arguments);
            };
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; justify-content: center; align-items: center; padding: 1rem; }
        .modal { transform: translateY(-50px); transition: transform 0.3s ease-out, opacity 0.3s ease-out; opacity: 0; }
        .modal-backdrop.flex { display: flex; }
        .modal-backdrop.flex .modal { transform: translateY(0); opacity: 1; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-paid { background-color: #dcfce7; color: #166534; }
        .status-sent { background-color: #cffafe; color: #0e7490; }
        .status-overdue { background-color: #fee2e2; color: #991b1b; }
        .status-active { background-color: #e0e7ff; color: #3730a3; }
        .sequence-active-badge { background-color: #ede9fe; color: #5b21b6; }
        .delivery-method-btn.active { background-color: white; color: #4f46e5; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .plan-card { border: 2px solid transparent; }
        .plan-card.popular { border-color: #6366f1; }
        .faq-answer { 
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.3s ease-out; 
    padding: 0 1.5rem;
    opacity: 0;
}
.faq-answer.open { 
    max-height: 200px;
    padding: 0 1.5rem 1.5rem 1.5rem; 
    opacity: 1;
}
.faq-question.open svg,
.faq-question.open i[data-lucide="chevron-down"] {
    transform: rotate(180deg);
}
        .upgrade-overlay { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .group:hover .upgrade-overlay { opacity: 1; }
        .legal-content h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; margin-top: 1.5rem; }
        .legal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1.5rem; }
        .legal-content p { margin-bottom: 1rem; line-height: 1.6; }
        .legal-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }

    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app">
        <!-- View: Main Dashboard -->
        <div id="mainView">
            <header class="bg-white shadow-sm sticky top-0 z-30">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="bell-ring" class="text-indigo-600"></i>
                            <h1 class="text-xl font-bold text-slate-900">Invoice Reminder</h1>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="viewPricingBtn" class="inline-flex items-center justify-center rounded-lg text-sm font-semibold py-2 px-3 bg-amber-100 text-amber-800 hover:bg-amber-200 transition-colors">
                                <i data-lucide="gem" class="w-4 h-4 mr-2 text-amber-800"></i>
                                <span id="planStatusText">Starter Plan</span>
                            </button>
                            <button id="billingSettingsBtn" class="hidden inline-flex items-center justify-center rounded-lg text-sm font-semibold py-2 px-3 bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors" title="Billing Settings">
                                <i data-lucide="credit-card" class="w-4 h-4 mr-2"></i>
                                <span>Billing</span>
                            </button>
                            <button id="signInBtn" class="ml-2 px-4 py-2 text-sm font-semibold bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100">Sign In</button>
                            <button id="signOutBtn" class="hidden p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-red-600 transition-colors" title="Sign Out">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Welcome Message -->
                <div id="welcomeMessage" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <i data-lucide="check-circle" class="w-5 h-5 text-blue-500 mt-0.5 mr-3"></i>
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-blue-800">Welcome to Invoice Reminder!</h3>
                            <p class="text-sm text-blue-700 mt-1">Your app is ready to use. Create invoices, set reminders, and manage your business easily.</p>
                        </div>
                        <button id="closeWelcomeBtn" class="text-blue-400 hover:text-blue-600">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                

                
                <!-- Usage Meter -->
                <div id="usageMeter" class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-slate-800">Monthly Reminder Usage</h3>
                        <span id="usageText" class="text-sm font-semibold text-slate-600">0 / 3</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div id="usageProgressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="limitWarning" class="hidden text-center text-sm mt-2">
                        <span id="limitWarningText"></span>
                        <button class="font-bold underline text-indigo-600 hover:text-indigo-800 upgrade-link">Upgrade now.</button>
                        </button>
                    </p>
                </div>

                <!-- AI Scheduling Section (Pro & Business Only) -->
                <div id="aiSchedulingSection" class="hidden bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-semibold text-slate-800">AI Follow-up Automation</h3>
                            <p class="text-xs text-slate-500">Pro & Business Feature</p>
                    </div>
                        <button id="setupAIScheduleBtn" class="inline-flex items-center justify-center rounded-lg text-sm font-semibold py-2 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700 transition-colors">
                            <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                            <span>Setup AI Schedule</span>
                            </button>
                        </div>
                    <div id="aiScheduleStatus" class="text-sm text-slate-600">
                        <p class="mb-2">Set up automated reminder sequences for your invoices.</p>
                        <div class="flex items-center gap-2 text-xs text-slate-500">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            <span>Sequences automatically stop when invoices are marked as paid</span>
                                    </div>
                    </div>
                </div>

                <div id="loadingState" class="text-center py-12"><i data-lucide="loader-2" class="animate-spin text-indigo-500 w-8 h-8 mx-auto"></i><p class="mt-2 text-slate-500">Loading invoices...</p></div>
                                    <div id="emptyState" class="hidden text-center py-12 border-2 border-dashed border-slate-300 rounded-lg"><i data-lucide="file-text" class="w-12 h-12 mx-auto text-slate-400"></i><h3 class="mt-2 text-lg font-semibold text-slate-800">No Invoices Found</h3><p class="mt-1 text-sm text-slate-500">Get started by adding your first invoice.</p><button id="addInvoiceBtnEmpty" class="mt-4 inline-flex items-center justify-center rounded-lg text-sm font-semibold py-2 px-4 bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"><i data-lucide="plus" class="w-4 h-4 mr-2"></i><span>Add Invoice</span></button></div>
                                    <div id="invoiceListContainer" class="hidden"><div class="bg-white shadow-sm rounded-lg overflow-hidden"><ul id="invoiceList" class="divide-y divide-slate-200"></ul></div><div class="mt-6 text-center"><button id="addInvoiceBtnList" class="inline-flex items-center justify-center rounded-lg text-sm font-semibold py-3 px-6 bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"><i data-lucide="plus" class="w-4 h-4 mr-2"></i><span>Add Another Invoice</span></button></div></div>
            </main>
            

        </div>

        <!-- View: Pricing Page -->
        <div id="pricingView" class="hidden bg-slate-50 min-h-screen">
            <header class="bg-white shadow-sm"><div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between items-center h-16"><h2 class="text-xl font-bold text-slate-900">Plans & Pricing</h2><button id="backToDashboardBtn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard</button></div></div></header>
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="text-center"><h3 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">Find the perfect plan for your business</h3><p class="mt-3 max-w-2xl mx-auto text-lg text-slate-600">Stop chasing payments. Start automating.</p></div>
                <div class="mt-12 grid gap-8 md:grid-cols-3">
                    <!-- Free Plan -->
                    <div class="plan-card bg-white rounded-2xl shadow-lg p-8"><h4 class="text-lg font-semibold text-slate-900">Starter</h4><p class="mt-2 text-slate-500">For freelancers and small businesses just getting started.</p><p class="mt-6"><span class="text-4xl font-bold tracking-tight text-slate-900">$0</span><span class="text-base font-medium text-slate-500">/mo</span></p><button data-plan="free" class="select-plan-btn mt-6 w-full py-3 px-4 rounded-lg bg-indigo-100 text-indigo-700 font-semibold hover:bg-indigo-200">Your Current Plan</button><ul class="mt-8 space-y-4 text-sm text-slate-700"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Unlimited Invoices</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i><b>3</b> Manual Reminders / mo</li><li class="flex items-center gap-3"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i>AI Follow-up Sequences</li><li class="flex items-center gap-3"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i>Email & SMS Automation</li><li class="flex items-center gap-3 text-slate-400"> <i data-lucide="x" class="w-5 h-5"></i> <span>CRM Integration</span> <a href="https://buy.stripe.com/cNi4gA18l14Z9RX8qVdAk01" target="_blank" class="ml-auto text-xs font-bold text-amber-600 hover:text-amber-800 flex items-center gap-1"> <i data-lucide="gem" class="w-3 h-3"></i> Upgrade </a> </li></ul></div>
                    <!-- Pro Plan -->
                    <div class="plan-card popular bg-white rounded-2xl shadow-2xl p-8 relative"><div class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2"><div class="bg-indigo-600 text-white text-xs font-semibold tracking-wider uppercase rounded-full px-3 py-1">Most Popular</div></div><h4 class="text-lg font-semibold text-slate-900">Pro</h4><p class="mt-2 text-slate-500">For growing businesses that want to automate their workflow.</p><p class="mt-6"><span class="text-4xl font-bold tracking-tight text-slate-900">$29</span><span class="text-base font-medium text-slate-500">/mo</span></p><a href="https://buy.stripe.com/3cI7sM3gtbJDe8d22xdAk00" target="_blank" class="mt-6 block text-center w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Upgrade to Pro</a><ul class="mt-8 space-y-4 text-sm text-slate-700"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Everything in Starter</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>AI Follow-up Sequences</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Email Automation</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i><b>100</b> reminders / month</li><li class="flex items-center gap-3 text-slate-400"> <i data-lucide="x" class="w-5 h-5"></i> <span>CRM Integration</span> <a href="https://buy.stripe.com/cNi4gA18l14Z9RX8qVdAk01" target="_blank" class="ml-auto text-xs font-bold text-amber-600 hover:text-amber-800 flex items-center gap-1"> <i data-lucide="gem" class="w-3 h-3"></i> Upgrade </a> </li></ul></div>
                    <!-- Business Plan -->
                    <div class="plan-card bg-white rounded-2xl shadow-lg p-8"><h4 class="text-lg font-semibold text-slate-900">Business</h4><p class="mt-2 text-slate-500">For established businesses and agencies scaling up.</p><p class="mt-6"><span class="text-4xl font-bold tracking-tight text-slate-900">$79</span><span class="text-base font-medium text-slate-500">/mo</span></p><a href="https://buy.stripe.com/cNi4gA18l14Z9RX8qVdAk01" target="_blank" class="block text-center w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Upgrade to Business</a><ul class="mt-8 space-y-4 text-sm text-slate-700"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Everything in Pro</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i><b>500</b> reminders / month</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Team Collaboration</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>CRM Integration</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-indigo-500"></i>Priority Support</li></ul></div>
                </div>
                <!-- FAQ Section -->
                <div id="faqSection" class="mt-20 max-w-3xl mx-auto">
                    <h3 class="text-center text-2xl font-bold text-slate-900">Frequently Asked Questions</h3>
                    <div class="mt-8 space-y-4">
                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">What is Invoice Reminder?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">Invoice Reminder is a tool that automates your invoice follow-ups via email and SMS, so you get paid faster without chasing clients manually.</p></div></div>
                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">Who is this for?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">It's built for freelancers, small businesses, agencies, and finance teams who want to save time and improve cash flow.</p></div></div>
                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">Can I send both email and SMS reminders?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">Yes, our Pro and Business plans allow you to send automated reminders via email, SMS, or both simultaneously.</p></div></div>
                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">How do automated follow-up sequences work?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">You set the schedule for reminders (e.g., 7 days before due, on the due date, and weekly after). Once an invoice is marked as paid, the sequence stops automatically. This is a Pro feature.</p></div></div>

                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">What happens if I hit my monthly reminder limit?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">You can upgrade your plan instantly from your dashboard to increase your limit and continue sending reminders. We'll notify you as you get close to your limit.</p></div></div>
                        <!-- FAQ Item -->
                        <div class="faq-item bg-white rounded-lg shadow-sm"><button class="faq-question flex justify-between items-center w-full p-6 text-left"><span class="font-semibold text-slate-800">Can I cancel anytime?</span><i data-lucide="chevron-down" class="transition-transform duration-300"></i></button><div class="faq-answer"><p class="text-slate-600 text-sm">Yes, you can cancel your subscription at any time from your account dashboard—no hidden fees. You will retain access to your plan's features until the end of the current billing period.</p></div></div>
                    </div>
                </div>
                 <footer class="mt-20 text-center text-sm text-slate-500">
                    <button data-view="termsView" class="view-link hover:underline">Terms</button>
                    <span class="mx-2">&middot;</span>
                    <button data-view="privacyView" class="view-link hover:underline">Privacy</button>
                </footer>
            </div>
        </div>
        
        <!-- View: Message Detail Page -->
        <div id="messageDetailView" class="hidden">
            <header class="bg-white shadow-sm"><div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between items-center h-16"><h2 class="text-xl font-bold text-slate-900">Message History</h2><button id="backToDashboardFromDetailBtn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard</button></div></div></header>
            <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="border-b pb-4 mb-4">
                        <p class="text-sm text-slate-500">Client: <strong id="detailClientName" class="text-slate-800"></strong></p>
                        <p class="text-sm text-slate-500">Invoice Amount: <strong id="detailInvoiceAmount" class="text-slate-800"></strong></p>
                    </div>
                    <div id="messageLogContainer">
                        <!-- Message logs will be injected here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- View: Terms Page -->
        <div id="termsView" class="hidden bg-slate-50 min-h-screen">
            <header class="bg-white shadow-sm"><div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between items-center h-16"><h2 class="text-xl font-bold text-slate-900">Terms of Service</h2><button class="back-to-pricing-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Pricing</button></div></div></header>
            <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="bg-white p-8 rounded-lg shadow-sm legal-content">
                    <p><strong>Last Updated: September 17, 2025</strong></p>
                    <p>Welcome to Invoice Reminder! These Terms of Service ("Terms") govern your use of our website, services, and application (collectively, the "Service"), operated by InvoiceReminder.xyz ("us", "we", or "our").</p>
                    <h2>1. Agreement to Terms</h2>
                    <p>By accessing or using our Service, you agree to be bound by these Terms. If you disagree with any part of the terms, then you may not access the Service.</p>
                    <h2>2. Accounts</h2>
                    <p>When you create an account with us, you must provide us with information that is accurate, complete, and current at all times. Failure to do so constitutes a breach of the Terms, which may result in immediate termination of your account on our Service.</p>
                    <p>You are responsible for safeguarding the password that you use to access the Service and for any activities or actions under your password.</p>
                    <h2>3. Subscriptions</h2>
                    <p>Some parts of the Service are billed on a subscription basis ("Subscription(s)"). You will be billed in advance on a recurring and periodic basis ("Billing Cycle").</p>
                    <p>At the end of each Billing Cycle, your Subscription will automatically renew under the exact same conditions unless you cancel it or InvoiceReminder.xyz cancels it. You may cancel your Subscription renewal either through your online account management page or by contacting customer support.</p>
                    <p>A valid payment method is required to process the payment for your Subscription. You shall provide InvoiceReminder.xyz with accurate and complete billing information including full name, address, state, zip code, and a valid payment method information. By submitting such payment information, you automatically authorize InvoiceReminder.xyz to charge all Subscription fees incurred through your account to any such payment instruments.</p>
                    <h2>4. Free Plan</h2>
                    <p>InvoiceReminder.xyz may, at its sole discretion, offer a Subscription with a free plan. The free plan allows for limited use of the Service. At any time and without notice, InvoiceReminder.xyz reserves the right to (i) modify the terms and conditions of the free plan offer, or (ii) cancel such free plan offer.</p>
                    <h2>5. User Content</h2>
                    <p>Our Service allows you to post, link, store, share and otherwise make available certain information, text, graphics, or other material ("Content"). You are responsible for the Content that you post to the Service, including its legality, reliability, and appropriateness.</p>
                    <h2>6. Prohibited Uses</h2>
                    <p>You may use the Service only for lawful purposes. You may not use the Service:</p>
                    <p>In any way that violates any applicable national or international law or regulation.</p>
                    <p>To exploit, harm, or attempt to exploit or harm minors in any way.</p>
                    <p>To transmit, or procure the sending of, any advertising or promotional material, including any "junk mail", "chain letter," "spam," or any other similar solicitation.</p>
                    <h2>7. Termination</h2>
                    <p>We may terminate or suspend your account immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach the Terms.</p>
                    <h2>8. Limitation of Liability</h2>
                    <p>In no event shall InvoiceReminder.xyz, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
                    <h2>9. Governing Law</h2>
                    <p>These Terms shall be governed and construed in accordance with the laws of the United States, without regard to its conflict of law provisions.</p>
                    <h2>10. Changes</h2>
                    <p>We reserve the right, at our sole discretion, to modify or replace these Terms at any time. We will provide at least 30 days' notice prior to any new terms taking effect.</p>
                </div>
            </main>
        </div>

        <!-- View: Billing Settings -->
        <div id="billingView" class="hidden bg-slate-50 min-h-screen">
            <header class="bg-white shadow-sm">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                            <i data-lucide="bell" class="w-6 h-6 text-indigo-600 cursor-pointer hover:text-indigo-800 transition-colors" onclick="showView('mainView')" title="Go to Dashboard"></i>
                            Billing & Subscription
                        </h2>
                        <button id="backToDashboardFromBillingBtn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard
                        </button>
                    </div>
                </div>
            </header>
            
            <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="billingLoading" class="animate-pulse p-4 rounded-xl bg-gray-100">
                    <div class="h-4 bg-gray-300 rounded w-1/4 mb-4"></div>
                    <div class="h-20 bg-gray-300 rounded"></div>
                </div>
                
                <div id="billingError" class="hidden p-4 rounded-xl bg-red-50 border border-red-200 text-red-700">
                    <div class="flex items-center">
                        <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                        <span id="billingErrorMessage"></span>
                    </div>
                </div>
                
                <div id="billingContent" class="hidden space-y-4">
                    <div class="p-4 rounded-2xl border bg-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-500">Plan status</div>
                                <div class="text-lg font-medium" id="planStatusDisplay">free</div>
                            </div>
                            <span id="premiumBadge" class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700">
                                Free
                            </span>
                        </div>

                        <div class="mt-4">
                            <div>
                                <div class="text-xs text-gray-500">Next renewal / access ends</div>
                                <div class="font-medium" id="renewalDate">—</div>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mt-4" id="billingInfo">
                            You can <strong>cancel anytime</strong> from the billing portal. If you cancel, you'll keep access
                            until the end of your current billing period. No hidden fees.
                        </p>

                        <div class="mt-4">
                            <div class="flex gap-3">
                                <button id="manageBillingBtn" class="hidden inline-flex items-center px-4 py-2 rounded-xl bg-black text-white hover:opacity-90 disabled:opacity-60">
                                    <span id="manageBillingText">Manage billing</span>
                                </button>
                                <button id="cancelSubscriptionBtn" class="hidden inline-flex items-center px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 disabled:opacity-60">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    <span id="cancelSubscriptionText">Cancel</span>
                                </button>
                            </div>
                            <div id="upgradePrompt" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center">
                                    <i data-lucide="info" class="w-5 h-5 text-blue-500 mr-2"></i>
                                    <div>
                                        <p class="text-sm text-blue-800 font-medium">Upgrade to manage billing</p>
                                        <p class="text-xs text-blue-600 mt-1">You need a paid plan to access billing management.</p>
                                    </div>
                                </div>
                                <button id="viewPlansBtn" class="mt-3 inline-flex items-center px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">
                                    <i data-lucide="arrow-up" class="w-4 h-4 mr-1"></i>
                                    View Plans
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- CRM Integration (Business plan) -->
                    <div id="crmCard" class="hidden p-4 rounded-2xl border bg-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-500">CRM Integration</div>
                                <div class="text-lg font-medium">CRM Integration</div>
                            </div>
                            <span id="crmStatusBadge" class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700">
                                Not connected
                            </span>
                        </div>

                        <p class="text-sm text-gray-600 mt-3">
                            Track contacts and log reminder activity in your personal CRM. Available on the <b>Business</b> plan.
                        </p>

                        <div class="mt-4 flex gap-3">
                            <button id="connectCrmBtn"
                                class="inline-flex items-center px-4 py-2 rounded-xl bg-black text-white hover:opacity-90">
                                Connect CRM
                            </button>
                            <button id="disconnectCrmBtn"
                                class="hidden inline-flex items-center px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700">
                                Disconnect
                            </button>
                            <button id="syncNowBtn"
                                class="hidden inline-flex items-center px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                Sync Now
                            </button>
                            <button id="viewCrmBtn"
                                class="hidden inline-flex items-center px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
                                <i data-lucide="eye" class="w-4 h-4 mr-2"></i>
                                View CRM Data
                            </button>
                        </div>

                        <div class="mt-3 text-xs text-gray-500" id="crmMeta">—</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: CRM Dashboard -->
        <div id="crmView" class="hidden bg-slate-50 min-h-screen">
            <header class="bg-white shadow-sm">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                            <i data-lucide="bell" class="w-6 h-6 text-indigo-600 cursor-pointer hover:text-indigo-800 transition-colors" onclick="showView('mainView')" title="Go to Dashboard"></i>
                            CRM Dashboard
                        </h2>
                        <div class="flex items-center gap-4">
                            <button id="syncAllInvoicesBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                Sync All Invoices
                            </button>
                            <button class="back-to-billing-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Billing
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- CRM Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Contacts</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalContacts">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i data-lucide="briefcase" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Active Deals</p>
                                <p class="text-2xl font-bold text-gray-900" id="activeDeals">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i data-lucide="activity" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Activities</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalActivities">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6">
                            <button class="crm-tab-btn active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-tab="contacts">
                                Contacts
                            </button>
                            <button class="crm-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="deals">
                                Deals
                            </button>
                            <button class="crm-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="activities">
                                Activities
                            </button>
                        </nav>
                    </div>

                    <!-- Contacts Tab -->
                    <div id="contactsTab" class="crm-tab-content p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Contacts</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    </tr>
                                </thead>
                                <tbody id="contactsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Contacts will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Deals Tab -->
                    <div id="dealsTab" class="crm-tab-content hidden p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Deals</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    </tr>
                                </thead>
                                <tbody id="dealsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Deals will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Activities Tab -->
                    <div id="activitiesTab" class="crm-tab-content hidden p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Activities</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="activitiesTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Activities will be loaded here -->
                                </tbody>
                            </table>
                            
                            <!-- Add Activity Button -->
                            <div class="mt-6 flex justify-end">
                                <button onclick="openActivityModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                    Add New Activity
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- View: Privacy Page -->
        <div id="privacyView" class="hidden bg-slate-50 min-h-screen">
            <header class="bg-white shadow-sm"><div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between items-center h-16"><h2 class="text-xl font-bold text-slate-900">Privacy Policy</h2><button class="back-to-pricing-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Pricing</button></div></div></header>
            <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="bg-white p-8 rounded-lg shadow-sm legal-content">
                    <h1>Privacy Policy</h1>
                    <p><strong>Last Updated: September 17, 2025</strong></p>
                    <p><strong>InvoiceReminder.xyz</strong> ("us", "we", or "our") operates the Invoice Reminder website and application (the "Service"). This page informs you of our policies regarding the collection, use, and disclosure of personal data when you use our Service and the choices you have associated with that data.</p>
                    <p>We use your data to provide and improve the Service. By using the Service, you agree to the collection and use of information in accordance with this policy.</p>
                    <hr>
                    <h2>1. Information Collection and Use</h2>
                    <p>We collect several different types of information for various purposes to provide and improve our Service to you.</p>
                    <p><strong>Types of Data Collected</strong></p>
                    <ul>
                        <li><strong>Personal Data:</strong> While using our Service, we may ask you to provide us with certain personally identifiable information that can be used to contact or identify you ("Personal Data"). This may include, but is not limited to: Email address, First name and last name, Cookies and Usage Data.</li>
                        <li><strong>Invoice Data:</strong> We collect and store the invoice data you provide, such as client names, email addresses, phone numbers, invoice amounts, and due dates, solely for the purpose of providing the reminder services.</li>
                        <li><strong>Usage Data:</strong> We may also collect information on how the Service is accessed and used ("Usage Data"). This Usage Data may include information such as your computer's Internet Protocol address (e.g. IP address), browser type, browser version, the pages of our Service that you visit, the time and date of your visit, the time spent on those pages, unique device identifiers and other diagnostic data.</li>
                    </ul>
                    <hr>
                    <h2>2. Use of Data</h2>
                    <p><strong>InvoiceReminder.xyz</strong> uses the collected data for various purposes:</p>
                    <ul>
                        <li>To provide and maintain our Service</li>
                        <li>To notify you about changes to our Service</li>
                        <li>To provide customer support</li>
                        <li>To gather analysis or valuable information so that we can improve our Service</li>
                        <li>To monitor the usage of our Service</li>
                        <li>To detect, prevent and address technical issues</li>
                    </ul>
                    <hr>
                    <h2>3. Data Storage and Security</h2>
                    <p>The security of your data is important to us. We use commercially acceptable means to protect your Personal Data, including encryption and secure cloud infrastructure. However, remember that no method of transmission over the Internet or method of electronic storage is 100% secure.</p>
                    <hr>
                    <h2>4. Service Providers</h2>
                    <p>We may employ third-party companies and individuals to facilitate our Service ("Service Providers"), to provide the Service on our behalf, or to assist us in analyzing how our Service is used. These third parties have access to your Personal Data only to perform these tasks on our behalf and are obligated not to disclose or use it for any other purpose.</p>
                    <ul>
                        <li><strong>Firebase (Google):</strong> We use Firebase for database, authentication, and hosting services.</li>
                        <li><strong>Stripe:</strong> We use Stripe for payment processing. We do not store your credit card details.</li>
                    </ul>
                    <hr>
                    <h2>5. Your Data Protection Rights</h2>
                    <p>You have certain data protection rights. <strong>InvoiceReminder.xyz</strong> aims to take reasonable steps to allow you to correct, amend, delete, or limit the use of your Personal Data.</p>
                    <ul>
                        <li>The right to access, update or delete the information we have on you.</li>
                        <li>The right of rectification.</li>
                        <li>The right to object.</li>
                        <li>The right of restriction.</li>
                        <li>The right to data portability.</li>
                        <li>The right to withdraw consent.</li>
                    </ul>
                    <hr>
                    <h2>6. Children's Privacy</h2>
                    <p>Our Service does not address anyone under the age of 18 ("Children"). We do not knowingly collect personally identifiable information from anyone under the age of 18. If you are a parent or guardian and you are aware that your Children has provided us with Personal Data, please contact us.</p>
                    <hr>
                    <h2>7. Changes to This Privacy Policy</h2>
                    <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page. You are advised to review this Privacy Policy periodically for any changes.</p>
                    <hr>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="signInModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-sm relative"><button class="cancel-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button><div class="p-8 space-y-6"><div class="text-center"><h2 class="text-2xl font-bold text-slate-900">Create an Account</h2><p class="text-slate-500 mt-1 text-sm">Save your invoices and unlock pro features.</p></div><button id="googleSignInBtn" class="w-full inline-flex items-center justify-center py-2.5 px-4 text-sm font-semibold rounded-lg text-slate-700 bg-white border border-slate-300 hover:bg-slate-50 transition-colors"><svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.37,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>Sign in with Google</button><div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-300"></div></div><div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-slate-500">Or continue with email</span></div></div><form id="emailAuthForm" class="space-y-4"><input type="email" id="emailInput" required class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="Email address"><input type="password" id="passwordInput" required class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="Password"><p id="authError" class="text-sm text-red-600 hidden"></p><div class="flex gap-4"><button type="submit" data-action="signin" class="w-full py-2.5 px-4 text-sm font-semibold rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">Sign In</button><button type="submit" data-action="signup" class="w-full py-2.5 px-4 text-sm font-semibold rounded-lg text-indigo-700 bg-indigo-100 hover:bg-indigo-200">Create Account</button></div></form></div></div></div>
    <div id="invoiceModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-lg"><form id="invoiceForm" class="p-6"><input type="hidden" id="invoiceId"><h2 id="modalTitle" class="text-xl font-bold mb-6">New Invoice</h2><div class="space-y-4"><div><label for="clientName" class="block text-sm font-medium text-slate-700">Client Name</label><input type="text" id="clientName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., Acme Corp"></div><div><label for="clientEmail" class="block text-sm font-medium text-slate-700">Client Email</label><input type="email" id="clientEmail" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., contact@acme.com"></div><div><label for="clientPhone" class="block text-sm font-medium text-slate-700">Client Phone (Optional)</label><input type="tel" id="clientPhone" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="123-456-7890" pattern="\d{3}-\d{3}-\d{4}" maxlength="12"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="amount" class="block text-sm font-medium text-slate-700">Amount ($)</label><input type="text" id="amount" required inputmode="decimal" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., 1,000.00"></div><div><label for="dueDate" class="block text-sm font-medium text-slate-700">Invoice Due Date</label><input type="date" id="dueDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div></div><div><label for="description" class="block text-sm font-medium text-slate-700">Description (Optional)</label><textarea id="description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., Website design services"></textarea></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="cancel-btn py-2 px-4 bg-white border border-slate-300 rounded-lg text-sm font-semibold text-slate-700 hover:bg-slate-50">Cancel</button><button type="submit" class="py-2 px-4 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700">Save Invoice</button></div></form></div></div>

    <div id="deleteConfirmModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-sm"><div class="p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i data-lucide="trash-2" class="h-6 w-6 text-red-600"></i></div><h3 class="mt-4 text-lg font-medium text-gray-900">Delete Invoice?</h3><p class="mt-2 text-sm text-gray-500">Are you sure? This action cannot be undone.</p></div><div class="bg-gray-50 px-4 py-3 sm:px-6 flex flex-row-reverse"><button type="button" id="confirmDeleteBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Delete</button><button type="button" class="cancel-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button></div></div></div>
    <div id="resendConfirmModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-sm"><div class="p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-amber-100"><i data-lucide="alert-triangle" class="w-6 h-6 text-amber-600"></i></div><h3 class="mt-4 text-lg font-medium text-gray-900">Send Another Reminder?</h3><p class="mt-2 text-sm text-gray-500">You sent a reminder less than 24 hours ago. Are you sure you want to send another one?</p></div><div class="bg-gray-50 px-4 py-3 sm:px-6 flex flex-row-reverse"><button type="button" id="confirmResendBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 sm:ml-3 sm:w-auto sm:text-sm">Send Anyway</button><button type="button" class="cancel-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button></div></div></div>
    <div id="emailConfigModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-lg"><div class="p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-lg font-bold text-gray-900">Email Configuration</h3><button class="cancel-btn text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-4"><div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><div class="flex"><i data-lucide="info" class="w-5 h-5 text-blue-400 mt-0.5 mr-3"></i><div><h4 class="text-sm font-medium text-blue-800">Setup Instructions</h4><p class="text-sm text-blue-700 mt-1">To send real emails, you need to configure EmailJS. Follow these steps:</p><ol class="text-sm text-blue-700 mt-2 list-decimal list-inside space-y-1"><li>Sign up at <a href="https://www.emailjs.com/" target="_blank" class="underline">EmailJS.com</a></li><li>Create an email service (Gmail, Outlook, etc.)</li><li>Create an email template with variables: {{to_name}}, {{invoice_amount}}, {{due_date}}, {{invoice_description}}, {{message}}</li><li>Copy your credentials below</li></ol></div></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Service ID</label><input type="text" id="emailjsServiceId" placeholder="e.g., service_abc123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Template ID</label><input type="text" id="emailjsTemplateId" placeholder="e.g., template_xyz789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Public Key</label><input type="text" id="emailjsPublicKey" placeholder="e.g., user_def456" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div class="flex items-center justify-between pt-4"><button type="button" id="testEmailBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i data-lucide="send" class="w-4 h-4 mr-2"></i>Test Email</button><button type="button" id="saveEmailConfigBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"><i data-lucide="save" class="w-4 h-5 mr-2"></i>Save Configuration</button></div></div></div></div></div>

    <!-- AI Scheduling Modal -->
    <div id="aiScheduleModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-2xl"><div class="p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-lg font-bold text-gray-900">AI Follow-up Schedule</h3><button class="cancel-btn text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-6"><div class="bg-purple-50 border border-purple-200 rounded-lg p-4"><div class="flex"><i data-lucide="zap" class="w-5 h-5 text-purple-400 mt-0.5 mr-3"></i><div><h4 class="text-sm font-medium text-purple-800">Automated Reminder Sequences</h4><p class="text-sm text-purple-700 mt-1">Set up intelligent follow-up schedules that automatically send reminders based on invoice due dates.</p></div></div></div><form id="aiScheduleForm" class="space-y-4"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Enable AI Scheduling</label><div class="flex items-center"><input type="checkbox" id="enableAIScheduling" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="enableAIScheduling" class="ml-2 block text-sm text-gray-900">Automatically send follow-up reminders to all invoices</label></div></div><div><label class="block text-sm font-medium text-gray-700 mb-3">Reminder Schedule</label><div class="space-y-3"><div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"><div class="flex items-center"><input type="checkbox" id="reminder7days" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="reminder7days" class="ml-3 block text-sm font-medium text-gray-900">7 days before due date</label></div><div class="text-xs text-gray-500">Gentle reminder</div></div><div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"><div class="flex items-center"><input type="checkbox" id="reminder3days" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="reminder3days" class="ml-3 block text-sm font-medium text-gray-900">3 days before due date</label></div><div class="text-xs text-gray-500">Urgent reminder</div></div><div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"><div class="flex items-center"><input type="checkbox" id="reminderDue" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="reminderDue" class="ml-3 block text-sm font-medium text-gray-900">On due date</label></div><div class="text-xs text-gray-500">Final notice</div></div><div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"><div class="flex items-center"><input type="checkbox" id="reminderOverdue" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"><label for="reminderOverdue" class="ml-3 block text-sm font-medium text-gray-900">Weekly after due date</label></div><div class="text-xs text-gray-500">Follow-up collection</div></div></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Custom Message (Optional)</label><textarea id="customMessage" rows="3" placeholder="Add a personalized message to all automated reminders..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div></form><div class="flex items-center justify-between pt-4"><div class="text-sm text-gray-500"><i data-lucide="info" class="w-4 h-4 inline mr-1"></i>Sequences automatically stop when invoices are marked as paid</div><div class="flex space-x-3"><button type="button" class="cancel-btn px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button><button type="button" id="saveAIScheduleBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700"><i data-lucide="save" class="w-4 h-4 mr-2"></i>Save Schedule</button></div></div></div></div></div></div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal-backdrop"><div class="modal bg-white rounded-lg shadow-xl w-full max-w-lg"><form id="activityForm" class="p-6"><h2 class="text-xl font-bold mb-6">Add New Activity</h2><div class="space-y-4"><div><label for="activityType" class="block text-sm font-medium text-gray-700">Activity Type</label><select id="activityType" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option value="">Select a type...</option><option value="call">📞 Phone Call</option><option value="email">📧 Email</option><option value="meeting">🤝 Meeting</option><option value="reminder">⏰ Reminder</option><option value="note">📝 Note</option><option value="follow-up">🔄 Follow-up</option><option value="other">❓ Other</option></select></div><div><label for="contactEmail" class="block text-sm font-medium text-gray-700">Contact Email</label><input type="email" id="contactEmail" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., contact@client.com"></div><div><label for="activityNote" class="block text-sm font-medium text-gray-700">Note</label><textarea id="activityNote" rows="4" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describe the activity or interaction..."></textarea></div><div><label for="activityDate" class="block text-sm font-medium text-gray-700">Date & Time</label><input type="datetime-local" id="activityDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="cancel-btn py-2 px-4 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50">Cancel</button><button type="submit" class="py-2 px-4 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Activity</button></div></form></div></div></div>

    <div id="toast" class="hidden fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-lg flex items-center space-x-3 transition-opacity duration-300 opacity-0"><i id="toastIcon" data-lucide="check-circle" class="text-green-400"></i><span id="toastMessage"></span></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
                 createUserWithEmailAndPassword, signInWithEmailAndPassword,
                 signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc,
                 updateDoc, deleteDoc, query, where, getDoc, getDocs, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // EmailJS Configuration - Now using EmailJS for automatic email sending
        // Set up your credentials at https://www.emailjs.com/
        const EMAILJS_CONFIG = {
            serviceId: 'service_vme7axo', // Your new business email service ID
            templateId: 'template_yg5gfju', // Your EmailJS Template ID
            publicKey: '9rWSKXIXBLpoAD5p7' // Your EmailJS Public Key
        };

        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_CONFIG.publicKey);
        }


        // --- App State ---
        let currentUserId = null;
        let invoicesUnsubscribe = null;
        let userProfile = { plan: 'free', sendsThisMonth: 0 };

        const PLAN_LIMITS = { free: 3, pro: 100, business: 500 };

        // CRM Helper function for authenticated API calls
        async function authedPOST(path, body = {}) {
            const token = await auth.currentUser.getIdToken();
            const r = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            if (!r.ok) throw new Error(await r.text());
            return r.json().catch(() => ({}));
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCd9YCcqrL6XyxbfgV8UbDFK0wEg96_4K4",
            authDomain: "invoice-reminder-669a9.firebaseapp.com",
            projectId: "invoice-reminder-669a9",
            storageBucket: "invoice-reminder-669a9.firebasestorage.app",
            messagingSenderId: "1025595928236",
            appId: "1:1025595928236:web:1541073d36a2b9e8bbb909",
            measurementId: "G-HMJ4LTN4RL"
        };
        const appId = 'invoice-reminder-669a9';

        // Firebase instances (will be initialized later)
        let app, auth, db, googleProvider;

        // Firestore is now configured with modern settings

        // UI elements (query once)
        const addInvoiceBtnEmpty   = document.getElementById('addInvoiceBtnEmpty');
        const addInvoiceBtnList    = document.getElementById('addInvoiceBtnList');
        const signInBtn            = document.getElementById('signInBtn');
        const signOutBtn           = document.getElementById('signOutBtn');
        const invoiceModal         = document.getElementById('invoiceModal');
        const invoiceForm          = document.getElementById('invoiceForm');
        const invoiceList          = document.getElementById('invoiceList');
        const loadingState         = document.getElementById('loadingState');
        const emptyState           = document.getElementById('emptyState');
        const invoiceListContainer = document.getElementById('invoiceListContainer');
        const usageMeter           = document.getElementById('usageMeter');
        const planStatusText       = document.getElementById('planStatusText');
        const usageText            = document.getElementById('usageText');
        const usageProgressBar     = document.getElementById('usageProgressBar');
        const viewPricingBtn       = document.getElementById('viewPricingBtn');
        const limitWarning          = document.getElementById('limitWarning');
        const limitWarningText      = document.getElementById('limitWarningText');

        // Local storage key for guest invoices
        const LOCAL_STORAGE_INVOICES = 'guestInvoices';

        // --- Utility & View Functions ---
        const showView = (viewId) => {
            // Hide all views first
            const views = ['mainView', 'pricingView', 'messageDetailView', 'termsView', 'privacyView', 'billingView', 'crmView'];
            views.forEach(view => {
                const element = document.getElementById(view);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Show the requested view
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            } else {
                console.error(`View with ID '${viewId}' not found`);
                // Fallback to main view
                const mainView = document.getElementById('mainView');
                if (mainView) {
                    mainView.classList.remove('hidden');
                }
            }
        };

        // Make showView globally available for onclick attributes
        window.showView = showView;

        // Helper function to format date for email (clear and consistent format)
        const formatDateForEmail = (dateString) => {
            const date = new Date(dateString + 'T00:00:00');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${day}-${year}`; // Format: MM-DD-YYYY with dashes
        };

        // Helper function to format amount with commas
        const formatAmountForEmail = (amount) => {
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        // Helper function to check if running locally
        const isRunningLocally = () => {
            return window.location.hostname === 'localhost' ||
                   window.location.hostname === '127.0.0.1' ||
                   window.location.hostname === '' ||
                   window.location.protocol === 'file:';
        };

        // Helper function to get current domain for Firebase config
        const getCurrentDomain = () => {
            if (isRunningLocally()) {
                return 'localhost';
            }
            return window.location.hostname;
        };

        // Debug function to help troubleshoot Firebase configuration
        const debugFirebaseConfig = () => {
            console.log('=== Firebase Debug Info ===');
            console.log('Current URL:', window.location.href);
            console.log('Hostname:', window.location.hostname);
            console.log('Protocol:', window.location.protocol);
            console.log('Is running locally:', isRunningLocally());
            console.log('Firebase Auth Domain:', firebaseConfig.authDomain);
            console.log('Current Domain:', getCurrentDomain());

            if (isRunningLocally() && firebaseConfig.authDomain !== 'localhost') {
                console.warn('⚠️  WARNING: You are running locally but Firebase authDomain is not set to localhost');
                console.warn('This may cause OAuth redirect issues. Make sure to add localhost to authorized domains in Firebase console.');
            }

            if (auth) {
                console.log('Firebase Auth initialized:', !!auth);
                console.log('Current user:', auth.currentUser ? auth.currentUser.email : 'No user signed in');
            } else {
                console.error('Firebase Auth not initialized');
            }
        };

        // Expose debug function globally for console access
        window.debugFirebase = debugFirebaseConfig;

        // Function to test Firebase configuration
        const testFirebaseConfig = async () => {
            console.log('=== Testing Firebase Configuration ===');

            try {
                // Test if Firebase is initialized
                if (!auth) {
                    throw new Error('Firebase Auth not initialized');
                }
                console.log('✅ Firebase Auth initialized');

                // Test if Google provider is configured
                if (!googleProvider) {
                    throw new Error('Google Auth Provider not configured');
                }
                console.log('✅ Google Auth Provider configured');

                // Test Firestore connection
                if (!db) {
                    throw new Error('Firestore not initialized');
                }
                console.log('✅ Firestore initialized');

                // Test auth state listener
                const currentUser = auth.currentUser;
                console.log('✅ Auth state accessible, current user:', currentUser ? currentUser.email : 'No user');

                console.log('🎉 Firebase configuration test passed!');
                showToast('Firebase configuration looks good!', 'check-circle', 'text-green-400');

            } catch (error) {
                console.error('❌ Firebase configuration test failed:', error.message);
                showToast(`Configuration issue: ${error.message}`, 'alert-circle', 'text-red-400');
            }
        };

        // Expose test function globally
        window.testFirebaseConfig = testFirebaseConfig;

        // Initialize Firebase function
        const initializeFirebase = () => {
            // Check if Firebase SDK is loaded
            if (typeof initializeApp === 'undefined') {
                console.error('Firebase SDK not loaded');
                alert('Firebase SDK failed to load. Please check your internet connection and try refreshing the page.');
                return false;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                googleProvider = new GoogleAuthProvider();

                // Configure Google Auth Provider
                googleProvider.setCustomParameters({
                    prompt: 'select_account'
                });

                console.log('Firebase initialized successfully');
                // Run debug check after a short delay to ensure everything is loaded
                setTimeout(debugFirebaseConfig, 1000);
                return true;
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                
                // Provide more specific error information
                let errorMessage = 'Failed to initialize Firebase. ';
                
                if (error.code === 'app/duplicate-app') {
                    errorMessage += 'Firebase app already initialized.';
                } else if (error.message.includes('apiKey')) {
                    errorMessage += 'Invalid API key. Please check your Firebase configuration.';
                } else if (error.message.includes('authDomain')) {
                    errorMessage += 'Invalid auth domain. Please check your Firebase configuration.';
                } else if (error.message.includes('projectId')) {
                    errorMessage += 'Invalid project ID. Please check your Firebase configuration.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
                return false;
            }
        };

        function showToast(message, icon = 'check-circle', color = 'text-green-400') {
            const toast = document.getElementById('toast');
            const toastIconEl = document.getElementById('toastIcon');
            const toastMessageEl = document.getElementById('toastMessage');

            if (!toast || !toastIconEl || !toastMessageEl) {
                console.log('Toast message:', message);
                return;
            }

            // update message
            toastMessageEl.textContent = message;
            // update lucide icon
            toastIconEl.setAttribute('data-lucide', icon);
            // update class using setAttribute instead of className assignment
            toastIconEl.setAttribute('class', `w-5 h-5 ${color}`);
            lucide.createIcons();

            toast.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        const openModal = (modalElement) => modalElement.classList.add('flex');
        const closeModal = (modalElement) => modalElement.classList.remove('flex');

        // Activity Modal Functions
        const openActivityModal = () => {
            // Set default date to current date/time
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            document.getElementById('activityDate').value = localDateTime.toISOString().slice(0, 16);

            // Clear form
            document.getElementById('activityForm').reset();

            // Open modal
            const activityModal = document.getElementById('activityModal');
            openModal(activityModal);
        };

        // Make function globally available
        window.openActivityModal = openActivityModal;

        const getStatus = (invoice) => {
            if (invoice.status === 'paid') return { text: 'Paid', class: 'status-paid' };
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const due = new Date(invoice.dueDate + 'T00:00:00');
            if (due < today) return { text: 'Overdue', class: 'status-overdue' };
            if (invoice.status === 'sent') return { text: 'Sent', class: 'status-sent' };
            return { text: 'Active', class: 'status-active' };
        };
        
        

        // Sync guest invoices to Firestore when user signs in
        async function syncGuestInvoices() {
            const guestData = localStorage.getItem(LOCAL_STORAGE_INVOICES);
            if (!guestData) return;
            try {
                const invoices = JSON.parse(guestData);
                const invRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                for (const inv of invoices) {
                    await addDoc(invRef, inv);
                }
                localStorage.removeItem(LOCAL_STORAGE_INVOICES);
                showToast('Guest invoices saved to your account.', 'check-circle', 'text-green-400');
            } catch (err) {
                console.error('Error syncing guest invoices:', err);
            }
        }

        // Save invoice for guest
        function saveInvoiceGuest(invoice) {
            const data = localStorage.getItem(LOCAL_STORAGE_INVOICES);
            const invoices = data ? JSON.parse(data) : [];
            // Add unique ID for guest invoices
            invoice.id = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            invoices.push(invoice);
            localStorage.setItem(LOCAL_STORAGE_INVOICES, JSON.stringify(invoices));
        }

        // --- Invoice Rendering ---
        const renderInvoices = (invoices) => {
            loadingState.style.display = 'none';
            emptyState.style.display = invoices.length === 0 ? 'block' : 'none';
            invoiceListContainer.style.display = invoices.length > 0 ? 'block' : 'none';

            invoiceList.innerHTML = '';
            invoices.forEach(invoice => {
                const status = getStatus(invoice);

                
                let statusElement;
                if (invoice.messageLog && invoice.messageLog.length > 0) {
                    statusElement = `<button data-action="view-message" data-id="${invoice.id}" class="status-badge ${status.class} hover:ring-2 hover:ring-offset-1 ring-cyan-500 transition-all">${status.text}</button>`;
                } else if (status.text === 'Overdue') {
                    // Make overdue status clickable even without message logs
                    statusElement = `<button data-action="view-message" data-id="${invoice.id}" class="status-badge ${status.class} hover:ring-2 hover:ring-offset-1 ring-cyan-500 transition-all">${status.text}</button>`;
                } else {
                    statusElement = `<span class="status-badge ${status.class}">${status.text}</span>`;
                }

                const li = document.createElement('li');
                li.className = 'p-4 sm:p-6';
                li.innerHTML = `<div class="flex items-start justify-between flex-wrap gap-4"><div class="flex-1 min-w-0"><div class="flex items-center gap-3"><p class="text-sm font-semibold text-indigo-600 truncate">${invoice.clientName}</p>${statusElement}</div><p class="mt-1 text-sm text-slate-500">${invoice.clientEmail}</p>${invoice.description ? `<p class="mt-1 text-xs text-slate-400 truncate">${invoice.description}</p>` : ''}</div><div class="flex-shrink-0 flex items-center gap-4 sm:gap-6 text-sm"><div class="text-right"><p class="font-semibold text-slate-900" data-amount="${invoice.amount}">$${parseFloat(invoice.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p><p class="text-slate-500">Due: ${new Date(invoice.dueDate + 'T00:00:00').toLocaleDateString()}</p></div><div class="flex items-center gap-2">${invoice.status !== 'paid' ? `<button data-action="send-reminder" data-id="${invoice.id}" title="Send Reminder" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="send" class="w-4 h-4"></i>Send Reminder</button><button data-action="markpaid" data-id="${invoice.id}" title="Mark as Paid" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700"><i data-lucide="check" class="w-4 h-4"></i></button>` : ''}<button data-action="delete" data-id="${invoice.id}" title="Delete" class="text-slate-400 hover:text-red-600 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div></div>`;
                invoiceList.appendChild(li);
            });
            lucide.createIcons();
        };

        // Function to render guest invoices from localStorage
        const renderGuestInvoices = () => {
            const guestData = localStorage.getItem(LOCAL_STORAGE_INVOICES);
            if (!guestData) {
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                invoiceListContainer.style.display = 'none';
                return;
            }
            
            try {
                const invoices = JSON.parse(guestData);
                renderInvoices(invoices);
            } catch (error) {
                console.error('Error parsing guest invoices:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                invoiceListContainer.style.display = 'none';
            }
        };

        // --- Firestore Logic ---
        const setupListeners = async (userId) => {
            console.log('Setting up listeners for user:', userId);
            try {
                                // User Profile Listener
                const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                const profileSnap = await getDoc(profileDocRef);
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                } else {
                    // Create default profile for new user
                    userProfile = { plan: 'free', sendsThisMonth: 0 };
                    await setDoc(profileDocRef, userProfile);
                }
            updateSubscriptionStatusUI();
                await updateAIScheduleStatus();

                // Check if AI scheduling is enabled and start processing
                const scheduleRef = doc(db, `artifacts/${appId}/users/${userId}/aiSchedule`, 'settings');
                const scheduleSnap = await getDoc(scheduleRef);
                if (scheduleSnap.exists() && scheduleSnap.data().enabled) {
                    console.log('AI scheduling is active, starting immediate processing for any pending reminders...');
                    // Start processing immediately for any pending reminders
                    setTimeout(async () => {
                        try {
                            await processAISchedules();
                            console.log('Initial AI schedule processing completed');
                        } catch (error) {
                            console.error('Error in initial AI schedule processing:', error);
                        }
                    }, 2000); // Give a bit more time for everything to load
                    
                    // Set up periodic processing every 30 minutes
                    setInterval(async () => {
                        try {
                            console.log('Running periodic AI schedule check...');
                            await processAISchedules();
                        } catch (error) {
                            console.error('Error in periodic AI schedule processing:', error);
                        }
                    }, 30 * 60 * 1000); // Every 30 minutes
                }

            // Invoice Listener
            if (invoicesUnsubscribe) invoicesUnsubscribe();
            const invoicesRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
            const q = query(invoicesRef);
            invoicesUnsubscribe = onSnapshot(q, (snapshot) => {
                const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                invoices.sort((a, b) => {
                    // First sort by status: unpaid first, then paid
                    if (a.status === 'paid' && b.status !== 'paid') return 1;
                    if (a.status !== 'paid' && b.status === 'paid') return -1;

                    // Then sort by client name alphabetically
                    const nameA = (a.clientName || '').toLowerCase();
                    const nameB = (b.clientName || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;

                    // If names are the same, sort by due date as secondary sort
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
                renderInvoices(invoices);
            }, (error) => { 
                console.error('Error loading invoices:', error);
                showToast('Error loading invoices.', 'alert-circle', 'text-red-400'); 
                loadingState.style.display = 'none'; 
            });
        } catch (error) {
            console.error('Error in setupListeners:', error);
            showToast('Failed to setup listeners', 'alert-circle', 'text-red-400');
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
        }
        };
        
        const updateSubscriptionStatusUI = () => {
            // Special access for testing - give agmart17@gmail.com Business plan access
            let plan = userProfile.plan;
            
            // Check for special access users
            if (auth.currentUser && auth.currentUser.email === 'agmart17@gmail.com') {
                plan = 'business';
            }
            
            // Check if user has upgraded via Stripe (you can add more emails here)
            const upgradedUsers = {
                'agmart17@gmail.com': 'business',
                // Add more users as needed: 'user@example.com': 'pro'
            };
            
            if (auth.currentUser && upgradedUsers[auth.currentUser.email]) {
                plan = upgradedUsers[auth.currentUser.email];
            }

            // Update userProfile.plan to match the actual plan for limit enforcement
            userProfile.plan = plan;
            
            const limit = PLAN_LIMITS[plan];
            const used = userProfile.sendsThisMonth;
            const percentage = Math.min((used / limit) * 100, 100);
            
            planStatusText.textContent = plan === 'free' ? 'Starter Plan' : 
                plan === 'pro' ? 'Pro Plan' : 'Business Plan';
            
            usageMeter.classList.remove('hidden');
            usageText.textContent = `${used} / ${limit}`;
            usageProgressBar.style.width = `${percentage}%`;
            
            // Show warning if approaching limit
            if (used >= limit * 0.8 && used < limit) {
                limitWarning.classList.remove('hidden');
                limitWarningText.textContent = `You're approaching your monthly limit of ${limit} reminders. `;
            } else if (used >= limit) {
                limitWarning.classList.remove('hidden');
                limitWarningText.textContent = `You've reached your monthly limit of ${limit} reminders. `;
            } else {
                limitWarning.classList.add('hidden');
            }

            // Show/hide AI scheduling section based on plan
            const aiSchedulingSection = document.getElementById('aiSchedulingSection');
            if (aiSchedulingSection) {
                if (plan === 'pro' || plan === 'business') {
                    console.log('Showing AI scheduling section for plan:', plan);
                    aiSchedulingSection.classList.remove('hidden');
                } else {
                    console.log('Hiding AI scheduling section for plan:', plan);
                    aiSchedulingSection.classList.add('hidden');
                }
            } else {
                console.log('AI scheduling section element not found');
            }

            // Toggle CRM card visibility by plan
            const crmCard = document.getElementById('crmCard');
            if (crmCard) {
                if (plan === 'business') {
                    crmCard.classList.remove('hidden');
                    refreshCrmStatus().catch(console.warn);
                } else {
                    crmCard.classList.add('hidden');
                }
            }
        };

        const updateUserProfile = async (data) => {
            const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
            await updateDoc(profileDocRef, data);
            userProfile = { ...userProfile, ...data };
            updateSubscriptionStatusUI();
            // Also update AI schedule status in case plan changed
            updateAIScheduleStatus();
        };

        // Manual test function for AI scheduling (call from browser console)
        window.testAIScheduling = async () => {
            console.log('=== MANUAL AI SCHEDULING TEST ===');
            console.log('Current user:', currentUserId);
            console.log('User profile:', userProfile);
            console.log('AI scheduling enabled:', userProfile?.plan !== 'free');

            if (!currentUserId || userProfile?.plan === 'free') {
                console.log('❌ AI scheduling not available for this user');
                return;
            }

            try {
                console.log('🔄 Running AI schedule processing...');
                await processAISchedules();
                console.log('✅ AI schedule processing completed');

                console.log('🔄 Running new invoice reminder check...');
                // Test with a dummy invoice
                const testInvoice = {
                    id: 'test-invoice',
                    clientName: 'Test Client',
                    clientEmail: 'test@example.com',
                    amount: 100,
                    dueDate: new Date().toISOString(),
                    description: 'Test Invoice'
                };
                await checkAndSendAIReminderForNewInvoice(testInvoice);
                console.log('✅ New invoice reminder check completed');

            } catch (error) {
                console.error('❌ Error in manual test:', error);
            }
        };

        // --- Helper Functions ---
        const setDefaultDueDate = () => {
            const today = new Date();
            const defaultDue = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            document.getElementById('dueDate').value = defaultDue.toISOString().split('T')[0];
        };
        
        // --- Global Functions ---
        window.openInvoiceModal = () => {
            console.log('openInvoiceModal called');
            if (invoiceModal) {
                openModal(invoiceModal);
                setDefaultDueDate();
            } else {
                console.error('invoiceModal element not found');
            }
        };

        // --- Event Handlers ---
        // Add Invoice button event listeners
        console.log('Setting up Add Invoice button event listeners...');
        console.log('addInvoiceBtnEmpty:', addInvoiceBtnEmpty);
        console.log('addInvoiceBtnList:', addInvoiceBtnList);
        
        if (addInvoiceBtnEmpty) {
            addInvoiceBtnEmpty.addEventListener('click', () => {
                console.log('Add Invoice Empty button clicked');
                openInvoiceModal();
            });
            console.log('Event listener added to addInvoiceBtnEmpty');
        } else {
            console.error('addInvoiceBtnEmpty element not found');
        }
        
        if (addInvoiceBtnList) {
            addInvoiceBtnList.addEventListener('click', () => {
                console.log('Add Invoice List button clicked');
                openInvoiceModal();
            });
            console.log('Event listener added to addInvoiceBtnList');
        } else {
            console.error('addInvoiceBtnList element not found');
        }
        
        // Invoice form submission - Fixed version with enhanced debugging
        if (invoiceForm) {
            console.log('Setting up invoice form event listener...');
            invoiceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Invoice form submitted!');
                
                // Check if all form elements exist
                const clientNameEl = document.getElementById('clientName');
                const clientEmailEl = document.getElementById('clientEmail');
                const clientPhoneEl = document.getElementById('clientPhone');
                const amountEl = document.getElementById('amount');
                const dueDateEl = document.getElementById('dueDate');
                const descriptionEl = document.getElementById('description');
                
                if (!clientNameEl || !clientEmailEl || !clientPhoneEl || !amountEl || !dueDateEl || !descriptionEl) {
                    console.error('Form elements not found:', {
                        clientName: !!clientNameEl,
                        clientEmail: !!clientEmailEl,
                        clientPhone: !!clientPhoneEl,
                        amount: !!amountEl,
                        dueDate: !!dueDateEl,
                        description: !!descriptionEl
                    });
                    showToast('Form elements not found', 'alert-circle', 'text-red-400');
                    return;
                }
                
                // Phone validation guard
                const phoneVal = clientPhoneEl.value.trim();
                if (phoneVal && !/^\d{3}-\d{3}-\d{4}$/.test(phoneVal)) {
                    showToast('Enter a valid 10-digit phone number (XXX-XXX-XXXX).', 'alert-circle', 'text-red-400');
                    clientPhoneEl.focus();
                    return;
                }
                
                const formData = {
                    clientName: clientNameEl.value.trim(),
                    clientEmail: clientEmailEl.value.trim(),
                    clientPhone: clientPhoneEl.value.trim(),
                    amount: parseFloat(amountEl.value.replace(/,/g, '')),
                    dueDate: dueDateEl.value,
                    description: descriptionEl.value.trim(),
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    messageLog: []
                };
                
                console.log('Invoice data:', formData);
                console.log('Current user ID:', currentUserId);
                
                try {
                    if (currentUserId) {
                        // Save to Firestore for authenticated users
                        console.log('Saving to Firestore...');
                        const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                        const docRef = await addDoc(invoicesRef, formData);
                        showToast('Invoice saved to your account!', 'check-circle', 'text-green-400');

                        // CRM sync for Business plan users (LOCAL VERSION)
                        if (userProfile.plan === 'business') {
                            try {
                                // Check if CRM is connected
                                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                                const profileSnap = await getDoc(profileDocRef);
                                const profileData = profileSnap.data();
                                const crm = profileData?.crm;
                                
                                if (crm && crm.connected) {
                                    // Create contact
                                    const contactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, formData.clientEmail);
                                    await setDoc(contactRef, {
                                        email: formData.clientEmail,
                                        firstName: formData.clientName.split(' ')[0] || formData.clientName,
                                        lastName: formData.clientName.split(' ').slice(1).join(' ') || '',
                                        phone: formData.clientPhone || '',
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    }, { merge: true });
                                    
                                    // Create deal
                                    const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, docRef.id);
                                    await setDoc(dealRef, {
                                        invoiceId: docRef.id,
                                        invoiceNumber: docRef.id.slice(-6).toUpperCase(),
                                        amount: formData.amount,
                                        dueDate: formData.dueDate,
                                        description: formData.description || '',
                                        contactEmail: formData.clientEmail,
                                        status: 'open',
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    }, { merge: true });
                                    
                                    console.log('CRM sync completed locally');
                                }
                            } catch (e) {
                                console.warn('CRM sync (invoice) failed:', e);
                            }
                        }

                        // Check for AI reminders for new invoice
                        await checkAndSendAIReminderForNewInvoice({ id: docRef.id, ...formData });
                    } else {
                        // Save to localStorage for guest users
                        console.log('Saving to localStorage...');
                        saveInvoiceGuest(formData);
                        showToast('Invoice saved as guest! Sign in to sync to your account.', 'check-circle', 'text-blue-400');
                    }
                    
                    closeModal(invoiceModal);
                    invoiceForm.reset();
                    setDefaultDueDate();
                    
                    // Refresh the display
                    if (currentUserId) {
                        // For authenticated users, the listener will update automatically
                    } else {
                        // For guest users, render the local storage invoices
                        renderGuestInvoices();
                    }
                } catch (error) {
                    console.error('Error saving invoice:', error);
                    showToast('Failed to save invoice', 'alert-circle', 'text-red-400');
                }
            });
            console.log('Invoice form event listener set up successfully');
        } else {
            console.error('Invoice form element not found!');
        }
        
        // Modal close button event listeners
        document.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                closeModal(invoiceModal);
                closeModal(document.getElementById('deleteConfirmModal'));
                closeModal(document.getElementById('signInModal'));
            });
        });
        
        // Delete confirmation
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            const invoiceId = document.getElementById('confirmDeleteBtn').dataset.id;
            if (invoiceId && currentUserId) {
                try {
                    const invoiceDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, invoiceId);
                    await deleteDoc(invoiceDocRef);
                    closeModal(document.getElementById('deleteConfirmModal'));
                    showToast('Invoice deleted successfully!', 'check-circle', 'text-green-400');
                } catch (error) {
                    console.error('Error deleting invoice:', error);
                    showToast('Failed to delete invoice', 'alert-circle', 'text-red-400');
            }
            }
        });
        
        // Other button event listeners
        document.getElementById('viewPricingBtn').addEventListener('click', () => showView('pricingView'));
        document.getElementById('billingSettingsBtn').addEventListener('click', () => {
            showView('billingView');
            loadBillingSettings();
        });

        document.getElementById('closeWelcomeBtn').addEventListener('click', () => document.getElementById('welcomeMessage').style.display = 'none');
        
        // Pricing page navigation
        document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('mainView'));
        document.getElementById('backToDashboardFromDetailBtn').addEventListener('click', () => showView('mainView'));
        document.getElementById('backToDashboardFromBillingBtn').addEventListener('click', () => showView('mainView'));
        
        // Legal page navigation
        document.querySelectorAll('.back-to-pricing-btn').forEach(btn => {
            btn.addEventListener('click', () => showView('pricingView'));
        });
        
        // FAQ functionality - Fixed version
        console.log('Setting up FAQ functionality...');
        
        // Use event delegation for FAQ toggling
        document.addEventListener('click', (e) => {
            // Check if the clicked element is an FAQ question
            const question = e.target.closest('.faq-question');
            if (!question) return;
            
            console.log('FAQ question clicked:', question);
            
            const item = question.parentElement;
            const answer = item.querySelector('.faq-answer');
            const icon = question.querySelector('i, svg');
            
            console.log('FAQ elements found:', { item, answer, icon });
            
            if (!answer) {
                console.error('FAQ answer not found');
                return;
            }
            
            // Close all other open FAQ items
            document.querySelectorAll('.faq-item').forEach(otherItem => {
                if (otherItem !== item) {
                    const otherAnswer = otherItem.querySelector('.faq-answer');
                    const otherQuestion = otherItem.querySelector('.faq-question');
                    const otherIcon = otherItem.querySelector('i, svg');
                    
                    if (otherAnswer) {
                        otherAnswer.classList.remove('open');
                        otherAnswer.style.maxHeight = '0';
                    }
                    if (otherQuestion) {
                        otherQuestion.classList.remove('open');
                    }
                    if (otherIcon) {
                        otherIcon.style.transform = 'rotate(0deg)';
                    }
                }
            });
            
            // Toggle the clicked item
            if (answer.classList.contains('open')) {
                console.log('Closing FAQ answer');
                answer.classList.remove('open');
                answer.style.maxHeight = '0';
                question.classList.remove('open');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            } else {
                console.log('Opening FAQ answer');
                answer.classList.add('open');
                answer.style.maxHeight = answer.scrollHeight + 'px';
                question.classList.add('open');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        });
        
        // View navigation links
        document.querySelectorAll('.view-link').forEach(link => {
            link.addEventListener('click', () => {
                const view = link.dataset.view;
                if (view) showView(view);
            });
        });
        
        // EmailJS configuration removed - using built-in mail client instead
        
        // Authentication event listeners - will be set up after Firebase initialization
        const setupAuthListeners = () => {
            if (!auth || !googleProvider) {
                console.error('Firebase not initialized, cannot set up auth listeners');
                return;
            }

            // Sign in button
            signInBtn.addEventListener('click', () => openModal(document.getElementById('signInModal')));
            
            // Google sign in
            document.getElementById('googleSignInBtn').addEventListener('click', async () => {
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    currentUserId = result.user.uid;
                    await setupListeners(currentUserId);
                    closeModal(document.getElementById('signInModal'));
                    showToast('Signed in successfully!', 'check-circle', 'text-green-400');
                } catch (error) {
                    console.error('Google sign-in error:', error);
                    showToast('Google sign-in failed: ' + error.message, 'alert-circle', 'text-red-400');
                }
            });
            
            // Email sign in/up
            document.getElementById('emailAuthForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const action = e.submitter.dataset.action;
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                
                try {
                    let result;
                    if (action === 'signup') {
                        result = await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        result = await signInWithEmailAndPassword(auth, email, password);
                    }
                    
                    currentUserId = result.user.uid;
                    await setupListeners(currentUserId);
                    closeModal(document.getElementById('signInModal'));
                    showToast(`${action === 'signup' ? 'Account created' : 'Signed in'} successfully!`, 'check-circle', 'text-green-400');
                } catch (error) {
                    console.error('Email auth error:', error);
                    document.getElementById('authError').textContent = error.message;
                    document.getElementById('authError').classList.remove('hidden');
                }
            });
            
            // Sign out
            signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    currentUserId = null;
                    if (invoicesUnsubscribe) {
                        invoicesUnsubscribe();
                        invoicesUnsubscribe = null;
                    }
                    showToast('Signed out successfully!', 'log-out', 'text-blue-400');
                } catch (error) {
                    console.error('Sign out error:', error);
                    showToast('Sign out failed', 'alert-circle', 'text-red-400');
                }
            });
            
            // Auth state listener
            onAuthStateChanged(auth, async (user) => {
                console.log('Auth state changed:', user ? 'User signed in' : 'No user');
                if (user) {
                    currentUserId = user.uid;
                    await setupListeners(currentUserId);
                    signInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                    document.getElementById('billingSettingsBtn').classList.remove('hidden');

                    // Update AI schedule status after authentication
                    setTimeout(async () => {
                        await updateAIScheduleStatus();
                    }, 500); // Small delay to ensure everything is loaded
                } else {
                    currentUserId = null;
                    if (invoicesUnsubscribe) {
                        invoicesUnsubscribe();
                        invoicesUnsubscribe = null;
                    }
                    signInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                    document.getElementById('billingSettingsBtn').classList.add('hidden');
                    loadingState.style.display = 'none';
                    renderGuestInvoices();
                }
            });
        };
        
        // AI Scheduling Functions
        const loadAIScheduleSettings = async () => {
            if (!currentUserId) {
                showToast('Please sign in to load AI schedule settings', 'alert-circle', 'text-red-400');
                return;
            }

            try {
                const scheduleRef = doc(db, `artifacts/${appId}/users/${currentUserId}/aiSchedule`, 'settings');
                const snap = await getDoc(scheduleRef);

                if (snap.exists()) {
                    const settings = snap.data();

                    // Load settings into form
                    document.getElementById('enableAIScheduling').checked = settings.enabled || false;
                    document.getElementById('reminder7days').checked = settings.reminders?.includes('7days') || false;
                    document.getElementById('reminder3days').checked = settings.reminders?.includes('3days') || false;
                    document.getElementById('reminderDue').checked = settings.reminders?.includes('due') || false;
                    document.getElementById('reminderOverdue').checked = settings.reminders?.includes('overdue') || false;
                    document.getElementById('customMessage').value = settings.customMessage || '';
        } else {
                    // Default settings
                    document.getElementById('enableAIScheduling').checked = false;
                    document.getElementById('reminder7days').checked = true;
                    document.getElementById('reminder3days').checked = true;
                    document.getElementById('reminderDue').checked = true;
                    document.getElementById('reminderOverdue').checked = false;
                    document.getElementById('customMessage').value = '';
                }
            } catch (error) {
                console.error('Error loading AI schedule settings:', error);
                showToast('Failed to load AI schedule settings', 'alert-circle', 'text-red-400');
            }
        };

        const saveAIScheduleSettings = async () => {
            if (!userProfile || !userProfile.plan) {
                showToast('Please wait for the app to load completely', 'alert-circle', 'text-red-400');
                return;
            }

            const currentPlan = userProfile.plan;
            if (currentPlan !== 'pro' && currentPlan !== 'business') {
                showToast('AI scheduling is only available for Pro and Business plans', 'gem', 'text-amber-500');
                return;
            }

            try {
                const enabled = document.getElementById('enableAIScheduling').checked;
                const reminders = [];
                if (document.getElementById('reminder7days').checked) reminders.push('7days');
                if (document.getElementById('reminder3days').checked) reminders.push('3days');
                if (document.getElementById('reminderDue').checked) reminders.push('due');
                if (document.getElementById('reminderOverdue').checked) reminders.push('overdue');

                const customMessage = document.getElementById('customMessage').value;

                const settings = {
                    enabled,
                    reminders,
                    customMessage,
                    lastUpdated: new Date(),
                    userId: currentUserId
                };

                const scheduleRef = doc(db, `artifacts/${appId}/users/${currentUserId}/aiSchedule`, 'settings');
                await setDoc(scheduleRef, settings);

                console.log('AI schedule settings saved:', settings);

                // Update AI schedule status display
                await updateAIScheduleStatus();

                showToast('AI schedule settings saved successfully!', 'check-circle', 'text-green-400');
                closeModal(document.getElementById('aiScheduleModal'));

                // If enabled, start processing schedules
                if (enabled) {
                    processAISchedules();
                }
            } catch (error) {
                console.error('Error saving AI schedule settings:', error);
                showToast('Failed to save AI schedule settings', 'alert-circle', 'text-red-400');
            }
        };

        const updateAIScheduleStatus = async () => {
            console.log('updateAIScheduleStatus called, currentUserId:', currentUserId);

            if (!currentUserId) {
                console.log('No currentUserId, hiding AI scheduling section');
                // User not signed in, hide AI scheduling section
                const aiSection = document.getElementById('aiSchedulingSection');
                if (aiSection) aiSection.classList.add('hidden');
                return;
            }

            try {
                const scheduleRef = doc(db, `artifacts/${appId}/users/${currentUserId}/aiSchedule`, 'settings');
                const snap = await getDoc(scheduleRef);

                console.log('AI schedule settings loaded:', snap.exists() ? snap.data() : 'No settings found');

                const statusDiv = document.getElementById('aiScheduleStatus');
                if (snap.exists() && snap.data().enabled) {
                    statusDiv.innerHTML = `
                        <p class="mb-2 text-green-700 font-medium">✓ AI scheduling is active</p>
                        <div class="text-xs text-slate-500">
                            <span>Automated reminders will be sent according to your schedule.</span>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <p class="mb-2">Set up automated reminder sequences for your invoices.</p>
                        <div class="flex items-center gap-2 text-xs text-slate-500">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            <span>Sequences automatically stop when invoices are marked as paid</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating AI schedule status:', error);
            }
        };

        // Billing Settings Functions
        const formatUnix = (ts) => {
            if (!ts) return "—";
            return new Date(ts * 1000).toLocaleString();
        };

        const loadBillingSettings = async () => {
            const loadingEl = document.getElementById('billingLoading');
            const errorEl = document.getElementById('billingError');
            const contentEl = document.getElementById('billingContent');
            const errorMessageEl = document.getElementById('billingErrorMessage');

            // Show loading state
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            if (!currentUserId) {
                errorMessageEl.textContent = "Please sign in to view billing.";
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const userRef = doc(db, 'users', currentUserId);
                const snap = await getDoc(userRef);
                const subData = snap.exists() ? snap.data() : {};

                // Determine user's plan using the same logic as the main app
                let userPlan = subData.plan || 'free';
                
                // Special access for testing - give agmart17@gmail.com Business plan access
                if (auth.currentUser && auth.currentUser.email === 'agmart17@gmail.com') {
                    userPlan = 'business';
                }

                // Check upgraded users
                const upgradedUsers = {
                    'agmart17@gmail.com': 'business',
                };

                if (auth.currentUser && upgradedUsers[auth.currentUser.email]) {
                    userPlan = upgradedUsers[auth.currentUser.email];
                }

                // Add plan info to subData for UI update
                subData.userPlan = userPlan;

                // Update UI with subscription data
                updateBillingUI(subData);
                
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading billing settings:', error);
                errorMessageEl.textContent = error.message;
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        };

        const updateBillingUI = (subData) => {
            const now = Math.floor(Date.now() / 1000);
            const active = ["active", "trialing", "past_due"].includes(subData.status || "");
            const cancelGrace = !!subData.cancel_at_period_end && !!subData.current_period_end && now < subData.current_period_end;
            const hasPremium = active || cancelGrace;

            // Use the user's actual plan from the app logic
            const userPlan = subData.userPlan || 'free';
            
            // Map plan names to display names
            let planDisplayName = "Starter";
            let planName = "Free";
            
            if (userPlan === 'pro') {
                planDisplayName = "Pro";
                planName = "Pro";
            } else if (userPlan === 'business') {
                planDisplayName = "Business";
                planName = "Business";
            }

            // Update plan status
            document.getElementById('planStatusDisplay').textContent = planDisplayName;
            
            // Update premium badge
            const premiumBadge = document.getElementById('premiumBadge');
            if (hasPremium || userPlan !== 'free') {
                premiumBadge.textContent = `${planName} Plan`;
                premiumBadge.className = "px-3 py-1 rounded-full text-sm bg-emerald-100 text-emerald-700";
            } else {
                premiumBadge.textContent = "Free Plan";
                premiumBadge.className = "px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700";
            }


            // Update renewal date
            let renewalDate = "—";
            if (cancelGrace) {
                renewalDate = formatUnix(subData.current_period_end);
            } else if (active) {
                renewalDate = formatUnix(subData.current_period_end);
            } else if (userPlan !== 'free') {
                // For paid users without subscription data, show helpful message
                renewalDate = "No active subscription";
            } else {
                // For free users, show when they can upgrade
                renewalDate = "Upgrade anytime";
            }
            document.getElementById('renewalDate').textContent = renewalDate;

            // Update cancellation status - removed since cancellation section was removed from UI
            // let cancellationStatus = "Not scheduled";
            // if (subData.cancel_at_period_end) {
            //     cancellationStatus = "Scheduled (end of period)";
            // } else if (userPlan === 'free') {
            //     cancellationStatus = "N/A (Free plan)";
            // } else if (!subData.stripeCustomerId) {
            //     cancellationStatus = "N/A (No subscription)";
            // }
            // document.getElementById('cancellationStatus').textContent = cancellationStatus;

            // Update billing info text
            const billingInfo = document.getElementById('billingInfo');
            if (subData.current_period_end) {
                billingInfo.innerHTML = `You can <strong>cancel anytime</strong> from the billing portal. If you cancel, you'll keep access until <strong>${formatUnix(subData.current_period_end)}</strong>. No hidden fees.`;
            } else if (userPlan === 'free') {
                billingInfo.innerHTML = `Upgrade to a paid plan to access billing management features. You can <strong>cancel anytime</strong> with no hidden fees.`;
            } else {
                billingInfo.innerHTML = `You can <strong>cancel anytime</strong> from the billing portal. If you cancel, you'll keep access until the end of your current billing period. No hidden fees.`;
            }

            // Show/hide billing management buttons based on plan
            const manageBtn = document.getElementById('manageBillingBtn');
            const cancelBtn = document.getElementById('cancelSubscriptionBtn');
            const upgradePrompt = document.getElementById('upgradePrompt');
            
            if (userPlan !== 'free' && subData.stripeCustomerId) {
                // Paid user with Stripe customer ID - show billing management
                manageBtn.classList.remove('hidden');
                upgradePrompt.classList.add('hidden');
                
                // Show cancel button only for active subscriptions
                if (active && !subData.cancel_at_period_end) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }
            } else if (userPlan === 'business') {
                // Business plan user without Stripe customer ID - show cancel button
                manageBtn.classList.add('hidden');
                cancelBtn.classList.remove('hidden');
                upgradePrompt.classList.add('hidden');
            } else if (userPlan !== 'free' && !subData.stripeCustomerId) {
                // Other paid user without Stripe customer ID - hide both
                manageBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                upgradePrompt.classList.add('hidden');
            } else {
                // Free user - show upgrade prompt
                manageBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                upgradePrompt.classList.remove('hidden');
            }
        };

        const openBillingPortal = async () => {
            const manageBtn = document.getElementById('manageBillingBtn');
            const manageText = document.getElementById('manageBillingText');
            
            try {
                manageBtn.disabled = true;
                manageText.textContent = "Opening…";
                
                const token = await auth.currentUser.getIdToken();
                const res = await fetch("/.netlify/functions/create-portal-link", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const { url } = await res.json();
                window.location.href = url;
            } catch (error) {
                console.error('Error opening billing portal:', error);
                showToast(`Failed to open billing portal: ${error.message}`, 'alert-circle', 'text-red-400');
                manageBtn.disabled = false;
                manageText.textContent = "Manage billing / Cancel plan";
            }
        };

        const cancelSubscription = async () => {
            const cancelBtn = document.getElementById('cancelSubscriptionBtn');
            const cancelText = document.getElementById('cancelSubscriptionText');
            
            // Show confirmation dialog
            const confirmed = confirm(
                'Are you sure you want to cancel your Business plan access?\n\n' +
                'Your account will be downgraded to the free plan immediately.\n' +
                'You will lose access to premium features.\n\n' +
                'This action cannot be undone.'
            );
            
            if (!confirmed) return;
            
            try {
                cancelBtn.disabled = true;
                cancelText.textContent = "Cancelling...";
                
                // Update user's plan to free in Firestore
                const userRef = doc(db, 'users', currentUserId);
                await updateDoc(userRef, {
                    plan: 'free'
                });
                
                showToast('Business plan cancelled successfully. Your account has been downgraded to the free plan.', 'check-circle', 'text-green-400');
                
                // Reload billing settings to show updated status
                setTimeout(() => {
                    loadBillingSettings();
                }, 1000);
                
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                showToast(`Failed to cancel subscription: ${error.message}`, 'alert-circle', 'text-red-400');
                cancelBtn.disabled = false;
                cancelText.textContent = "Cancel";
            }
        };

        // CRM Status Management Functions
        async function refreshCrmStatus() {
            if (!currentUserId) return;
            // Fetch CRM status from Firestore profile (you'll store it server-side)
            const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
            const snap = await getDoc(profileDocRef);
            const data = snap.data() || {};
            const crm = data.crm || {};

            // Badges & buttons
            const badge = document.getElementById('crmStatusBadge');
            const btnConnect = document.getElementById('connectCrmBtn');
            const btnDisconnect = document.getElementById('disconnectCrmBtn');
            const btnSync = document.getElementById('syncNowBtn');
            const btnView = document.getElementById('viewCrmBtn');
            const meta = document.getElementById('crmMeta');

            const connected = !!crm.connected && (crm.provider === 'hubspot' || crm.provider === 'mock' || crm.provider === 'local');
            if (badge) {
                badge.textContent = connected ? 'Connected' : 'Not connected';
                badge.className = `px-3 py-1 rounded-full text-sm ${
                    connected ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-700'
                }`;
            }
            if (btnConnect) btnConnect.classList.toggle('hidden', connected);
            if (btnDisconnect) btnDisconnect.classList.toggle('hidden', !connected);
            if (btnSync) btnSync.classList.toggle('hidden', !connected);
            if (btnView) btnView.classList.toggle('hidden', !connected);

            if (meta) {
                const when = crm.lastSyncedAt ? new Date(crm.lastSyncedAt.seconds ? crm.lastSyncedAt.seconds*1000 : crm.lastSyncedAt).toLocaleString() : '—';
                meta.textContent = connected ? `Last synced: ${when}` : '—';
            }
        }

        // CRM Dashboard Functions
        async function loadCrmDashboard() {
            if (!currentUserId) {
                console.log('No current user ID, cannot load CRM dashboard');
                return;
            }
            
            try {
                console.log('Loading CRM dashboard for user:', currentUserId);
                console.log('App ID:', appId);
                console.log('Current User ID:', currentUserId);

                // Load contacts
                const contactsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                console.log('Loading contacts from path:', `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                const contactsSnap = await getDocs(contactsRef);
                console.log('Contacts snapshot:', contactsSnap);
                console.log('Number of contact documents:', contactsSnap.docs.length);

                const contacts = contactsSnap.docs.map(doc => {
                    const data = doc.data();
                    console.log('Contact document:', doc.id, data);
                    return { id: doc.id, ...data };
                });

                // Sort contacts alphabetically
                contacts.sort((a, b) => {
                    const nameA = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
                    const nameB = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                console.log('Loaded contacts:', contacts.length);
                console.log('Contact details (sorted):', contacts.map(c => ({ id: c.id, email: c.email, firstName: c.firstName, lastName: c.lastName })));

                // Check for specific missing contacts
                const missingNames = ['John Doeeeey', 'Neew new', 'THURSDD Dayyy', 'Thursaday Mannn', 'Thursday Test', 'Thursday333', 'dfdf', 'due today'];
                const foundContacts = contacts.filter(c =>
                    missingNames.some(name => c.firstName && c.firstName.includes(name)) ||
                    missingNames.some(name => c.lastName && c.lastName.includes(name)) ||
                    missingNames.some(name => c.email && c.email.includes(name))
                );
                console.log('Found matching contacts in CRM:', foundContacts);
                
                // Load deals
                const dealsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`);
                const dealsSnap = await getDocs(dealsRef);
                const deals = dealsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded deals:', deals.length);
                
                // Load activities
                const activitiesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmActivities`);
                const activitiesSnap = await getDocs(activitiesRef);
                const activities = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded activities:', activities.length);
                
                // Update stats using helper function
                updateCrmStats(contacts, deals, activities);
                
                // Render tables
                renderContactsTable(contacts);
                renderDealsTable(deals);
                renderActivitiesTable(activities);
                
                console.log('CRM dashboard loaded successfully');
                
            } catch (error) {
                console.error('Error loading CRM dashboard:', error);
                showToast('Failed to load CRM dashboard', 'alert-circle', 'text-red-400');
            }
        }

        // Sync all existing invoices to CRM
        async function syncAllInvoicesToCrm() {
            console.log('🔄 Starting CRM sync function...');
            console.log('Auth state:', {
                currentUser: auth.currentUser,
                currentUserId: currentUserId,
                isSignedIn: !!auth.currentUser
            });

            // Check authentication first
            if (!auth.currentUser) {
                showToast('You must be signed in to sync CRM data', 'alert-circle', 'text-red-400');
                console.error('❌ No authenticated user found');
                return;
            }

            if (!currentUserId) {
                showToast('User session expired. Please refresh and try again.', 'alert-circle', 'text-red-400');
                console.error('❌ No currentUserId available');
                return;
            }

            try {
                // Load user profile if not available
                if (!userProfile) {
                    console.log('🔄 Loading user profile...');
                    const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                    const profileSnap = await getDoc(profileDocRef);

                    if (profileSnap.exists()) {
                        userProfile = profileSnap.data();
                        console.log('✅ Loaded user profile:', userProfile);
                    } else {
                        userProfile = { plan: 'free', sendsThisMonth: 0 };
                        console.log('⚠️ No profile found, using default:', userProfile);
                    }
                }

                // Check if user has Business plan
                if (!userProfile || userProfile.plan !== 'business') {
                    showToast('CRM sync requires Business plan', 'alert-circle', 'text-red-400');
                    console.log('❌ User plan check failed:', userProfile);
                    return;
                }

                // Check if CRM is connected (reuse loaded profile data)
                if (!userProfile?.crm?.connected) {
                    showToast('CRM not connected. Please connect your CRM first.', 'alert-circle', 'text-red-400');
                    console.log('❌ CRM not connected in user profile:', userProfile);
                    return;
                }

                // Check if user is authenticated
                if (!auth.currentUser) {
                    showToast('You must be signed in to sync CRM data', 'alert-circle', 'text-red-400');
                    console.error('❌ No authenticated user found for CRM sync');
                    return;
                }

                // Check for special access (like agmart17@gmail.com)
                const userEmail = auth.currentUser.email;
                const hasSpecialAccess = userEmail === 'agmart17@gmail.com';

                if (!hasSpecialAccess && userProfile.plan !== 'business') {
                    showToast('CRM sync requires Business plan', 'alert-circle', 'text-red-400');
                    return;
                }

                console.log(`🔑 User access check: ${userEmail} (${hasSpecialAccess ? 'special access' : userProfile.plan + ' plan'})`);

                showToast('Starting full CRM sync...', 'loader', 'text-blue-400');

                // Clear console for better visibility
                console.clear();
                console.log('🚀 STARTING CRM SYNC DEBUG SESSION');
                console.log('=====================================');
                console.log('⚠️ Suppressing warnings for cleaner output...');
                
                // Suppress warnings during sync
                suppressWarnings();
                
                console.log('Starting CRM sync with:');
                console.log('App ID:', appId);
                console.log('Current User ID:', currentUserId);

                // Get all invoices
                const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                console.log('Loading invoices from path:', `artifacts/${appId}/users/${currentUserId}/invoices`);
                const invoicesSnap = await getDocs(invoicesRef);
                const invoices = invoicesSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`Found ${invoices.length} invoices to sync`);
                
                // Debug: Log all invoice details
                console.log('=== ALL INVOICES DEBUG ===');
                invoices.forEach((invoice, index) => {
                    console.log(`Invoice ${index + 1}:`, {
                        id: invoice.id,
                        clientName: invoice.clientName,
                        clientEmail: invoice.clientEmail,
                        clientPhone: invoice.clientPhone,
                        amount: invoice.amount,
                        dueDate: invoice.dueDate,
                        status: invoice.status
                    });
                });
                
                // Check for specific missing contacts
                const missingNames = ['John Doeeeey', 'Neew new', 'THURSDD Dayyy', 'Thursaday Mannn', 'Thursday Test', 'Thursday333', 'dfdf', 'due today'];

                console.log('=== MISSING CONTACTS DEBUG ===');
                console.log('Looking for these specific names:', missingNames);

                const foundInvoices = invoices.filter(inv =>
                    missingNames.some(name => inv.clientName && inv.clientName.includes(name))
                );
                console.log('✅ Found invoices with missing contact names:', foundInvoices);

                const allClientNames = invoices.map(inv => inv.clientName).filter(name => name);
                console.log('📋 All client names in invoices:', allClientNames);

                // Check each missing name individually
                missingNames.forEach(missingName => {
                    const matchingInvoices = invoices.filter(inv =>
                        inv.clientName && inv.clientName.includes(missingName)
                    );
                    if (matchingInvoices.length > 0) {
                        console.log(`✅ Found "${missingName}" in ${matchingInvoices.length} invoice(s):`, matchingInvoices.map(inv => ({id: inv.id, name: inv.clientName, email: inv.clientEmail})));
                    } else {
                        console.log(`❌ "${missingName}" NOT found in any invoices`);
                    }
                });

                console.log(`📊 Total invoices: ${invoices.length}`);
                console.log(`📧 Invoices with emails: ${invoices.filter(inv => inv.clientEmail).length}`);
                console.log(`📝 Invoices with names: ${invoices.filter(inv => inv.clientName).length}`);

                let syncedContacts = 0;
                let syncedDeals = 0;
                const processedEmails = new Set(); // Track unique emails to avoid double-counting

                // Process each invoice
                console.log(`🔄 Starting to process ${invoices.length} invoices...`);
                for (let i = 0; i < invoices.length; i++) {
                    const invoice = invoices[i];
                    console.log(`\n📄 Processing invoice ${i + 1}/${invoices.length}: ${invoice.id}`);
                    
                    try {
                        // Parse client data with better handling
                        let clientName = '';
                        let clientEmail = '';
                        let clientPhone = '';

                        // Handle clientName - ensure it's a string and not empty
                        if (invoice.clientName && typeof invoice.clientName === 'string' && invoice.clientName.trim()) {
                            clientName = invoice.clientName.trim();
                        } else {
                            clientName = `Unknown Client ${invoice.id.slice(-4)}`;
                            console.warn(`⚠️ Invoice ${invoice.id} has no client name, using: ${clientName}`);
                        }

                        // Handle clientEmail
                        if (invoice.clientEmail && typeof invoice.clientEmail === 'string' && invoice.clientEmail.trim()) {
                            clientEmail = invoice.clientEmail.trim();
                        }

                        // Handle clientPhone
                        if (invoice.clientPhone && typeof invoice.clientPhone === 'string' && invoice.clientPhone.trim()) {
                            clientPhone = invoice.clientPhone.trim();
                        }

                        // Handle missing emails - create placeholder for contacts without emails
                        if (!clientEmail) {
                            // Create a placeholder email for contacts without one
                            clientEmail = `no-email-${invoice.id}@placeholder.local`;
                            console.warn(`⚠️ Invoice ${invoice.id} has no email, using placeholder: ${clientEmail}`);
                        }
                        
                        console.log(`📝 Processing: "${clientName}" (${clientEmail}) - Amount: $${invoice.amount || 0}`);

                        // Create unique contact ID that combines email and client name
                        const uniqueContactId = `${clientEmail}-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        
                        // Check if this exact contact already exists in Firestore
                        const contactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, uniqueContactId);
                        const existingContact = await getDoc(contactRef);
                        const isNewContact = !existingContact.exists();
                        
                        // Also check our processed set to avoid double-counting in this sync session
                        const isNotProcessedInThisSession = !processedEmails.has(uniqueContactId);

                        // Create/update contact with better name parsing
                        const contactPath = `artifacts/${appId}/users/${currentUserId}/crmContacts`;

                        // Parse name more intelligently
                        const nameParts = clientName.split(' ').filter(part => part.trim());
                        let firstName = '';
                        let lastName = '';

                        if (nameParts.length === 0) {
                            firstName = 'Unknown';
                            lastName = 'Client';
                        } else if (nameParts.length === 1) {
                            firstName = nameParts[0];
                            lastName = '';
                        } else {
                            firstName = nameParts[0];
                            lastName = nameParts.slice(1).join(' ');
                        }

                        const contactData = {
                            email: clientEmail,
                            firstName: firstName,
                            lastName: lastName,
                            phone: clientPhone || '',
                            createdAt: new Date(),
                            updatedAt: new Date(),
                            originalInvoiceId: invoice.id,
                            source: 'invoice_sync',
                            uniqueContactId: uniqueContactId
                        };

                        console.log(`📝 Processing contact: "${clientName}" → "${firstName} ${lastName}" (${clientEmail})`);
                        console.log(`   Using unique ID: ${uniqueContactId}`);
                        console.log(`   Contact exists: ${existingContact.exists()}`);
                        console.log(`   Processed in session: ${processedEmails.has(uniqueContactId)}`);

                        // Only create/update contact if it doesn't exist or hasn't been processed in this session
                        if (isNewContact || isNotProcessedInThisSession) {
                            await setDoc(contactRef, contactData, { merge: true });

                            // Immediately verify the contact was saved
                            const verifyDoc = await getDoc(contactRef);
                            if (verifyDoc.exists()) {
                                const savedData = verifyDoc.data();
                                console.log(`✅ Successfully saved contact: "${clientName}" (${clientEmail})`);
                                console.log(`   Saved data: ${savedData.firstName} ${savedData.lastName} (${savedData.email})`);
                            } else {
                                console.error(`❌ Failed to save contact: "${clientName}" (${clientEmail})`);
                            }

                            if (isNewContact) {
                                syncedContacts++;
                                console.log(`📊 New contact added: ${syncedContacts}`);
                            } else {
                                console.log(`🔄 Contact updated (already existed)`);
                            }
                        } else {
                            console.log(`⏭️ Skipping duplicate contact: "${clientName}" (${clientEmail})`);
                        }

                        // Always add to processed set to prevent duplicates in this session
                        processedEmails.add(uniqueContactId);

                        // Create/update deal
                        const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, invoice.id);
                        const dealData = {
                            invoiceId: invoice.id,
                            invoiceNumber: invoice.id.slice(-6).toUpperCase(),
                            amount: invoice.amount || 0,
                            dueDate: invoice.dueDate || '',
                            description: invoice.description || '',
                            contactEmail: clientEmail,
                            status: invoice.status === 'paid' ? 'closed-won' : 'open',
                            createdAt: new Date(),
                            updatedAt: new Date()
                        };

                        await setDoc(dealRef, dealData, { merge: true });
                        console.log(`Synced deal: ${invoice.id}`, dealData);

                        syncedDeals++;

                    } catch (error) {
                        console.error(`❌ Error syncing invoice ${i + 1}/${invoices.length} (${invoice.id}):`, error);
                        console.error('Invoice data that caused error:', invoice);
                        console.error('Client data at time of error:', { clientName, clientEmail, clientPhone });
                        
                        // Try to continue with basic data even if there's an error
                        try {
                            console.log(`🔄 Attempting to sync invoice ${invoice.id} with minimal data...`);
                            const fallbackContactId = `error-${invoice.id}@fallback.local`;
                            const minimalContactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, fallbackContactId);
                            const minimalContactData = {
                                email: fallbackContactId,
                                firstName: invoice.clientName || 'Error',
                                lastName: 'Client',
                                phone: '',
                                createdAt: new Date(),
                                updatedAt: new Date(),
                                originalInvoiceId: invoice.id,
                                source: 'error_fallback',
                                uniqueContactId: fallbackContactId
                            };
                            await setDoc(minimalContactRef, minimalContactData, { merge: true });
                            syncedContacts++;
                            processedEmails.add(fallbackContactId);
                            console.log(`✅ Successfully created fallback contact for invoice ${invoice.id}`);
                        } catch (fallbackError) {
                            console.error(`❌ Even fallback sync failed for invoice ${invoice.id}:`, fallbackError);
                        }
                        
                        // Continue processing other invoices even if one fails
                        continue;
                    }
                }

                // Small delay to ensure Firestore changes are propagated
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Refresh CRM dashboard multiple times to ensure data is loaded
                console.log('Refreshing CRM dashboard after sync...');
                await loadCrmDashboard();
                console.log('CRM dashboard refreshed - first load');

                // Additional delay and refresh to ensure all data is loaded
                await new Promise(resolve => setTimeout(resolve, 500));
                await loadCrmDashboard();
                console.log('CRM dashboard refreshed - second load');

                // Force refresh all CRM data and stats
                console.log('🔄 Force refreshing all CRM data...');
                const contactsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                const dealsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`);
                const activitiesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmActivities`);
                
                const [contactsSnap, dealsSnap, activitiesSnap] = await Promise.all([
                    getDocs(contactsRef),
                    getDocs(dealsRef),
                    getDocs(activitiesRef)
                ]);
                
                const latestContacts = contactsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const latestDeals = dealsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const latestActivities = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update all stats and tables
                updateCrmStats(latestContacts, latestDeals, latestActivities);
                renderContactsTable(latestContacts);
                renderDealsTable(latestDeals);
                renderActivitiesTable(latestActivities);
                
                console.log(`📊 Force refreshed all CRM data - Contacts: ${latestContacts.length}, Deals: ${latestDeals.length}, Activities: ${latestActivities.length}`);

                // Final verification that the UI is updated correctly
                const finalTotalContactsEl = document.getElementById('totalContacts');
                if (finalTotalContactsEl) {
                    const displayedCount = finalTotalContactsEl.textContent;
                    console.log(`✅ Final verification - Total Contacts displayed: ${displayedCount}, Actual contacts: ${latestContacts.length}`);
                    if (displayedCount !== latestContacts.length.toString()) {
                        console.warn(`⚠️ Mismatch detected! Displayed: ${displayedCount}, Actual: ${latestContacts.length}`);
                        // Force update one more time
                        finalTotalContactsEl.textContent = latestContacts.length;
                    }
                }

                console.log('=== SYNC SUMMARY ===');
                console.log(`📊 Synced ${syncedContacts} unique contacts and ${syncedDeals} deals`);
                console.log(`📧 Processed ${processedEmails.size} unique email addresses`);
                console.log(`📄 Total invoices processed: ${invoices.length}`);
                console.log(`📈 Contact-to-Invoice ratio: ${syncedContacts}/${invoices.length} (${((syncedContacts/invoices.length)*100).toFixed(1)}%)`);
                
                // Show all processed emails for verification
                console.log('📧 All processed email addresses:', Array.from(processedEmails).sort());

                // First, verify all contacts were saved by checking the collection directly
                console.log('🔍 Verifying all contacts were saved...');
                const crmContactsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                const crmContactsSnap = await getDocs(crmContactsRef);
                const crmContacts = crmContactsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`📊 Found ${crmContacts.length} contacts in Firestore after sync`);
                console.log('All contacts in Firestore:', crmContacts.map(c => `${c.firstName} ${c.lastName} (${c.email})`));

                // Test creating one of the missing contacts manually
                console.log('🧪 Testing manual contact creation...');
                const testContactName = 'John Doeeeey';
                const testEmail = 'john@test.com';
                const testContactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, testEmail);
                const testContactData = {
                    email: testEmail,
                    firstName: 'John',
                    lastName: 'Doeeeey',
                    phone: '',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    source: 'manual_test'
                };

                await setDoc(testContactRef, testContactData, { merge: true });
                console.log(`✅ Manually created test contact: ${testContactName} (${testEmail})`);

                // Verify it was saved
                const testVerifyDoc = await getDoc(testContactRef);
                if (testVerifyDoc.exists()) {
                    console.log(`✅ Test contact verified in Firestore:`, testVerifyDoc.data());
                } else {
                    console.error(`❌ Test contact failed to save`);
                }

                // Check final state of missing contacts

                console.log(`🏢 Total contacts in CRM: ${crmContacts.length}`);

                // Detailed check for the specific missing contacts
                const missingContactsReport = [];
                missingNames.forEach(missingName => {
                    const matchingContacts = crmContacts.filter(c =>
                        (c.firstName && c.firstName.includes(missingName)) ||
                        (c.lastName && c.lastName.includes(missingName)) ||
                        (c.email && c.email.includes(missingName))
                    );

                    if (matchingContacts.length > 0) {
                        console.log(`✅ "${missingName}" found in CRM:`, matchingContacts.map(c => `${c.firstName} ${c.lastName} (${c.email})`));
                        missingContactsReport.push(`✅ ${missingName}: FOUND`);
                    } else {
                        console.log(`❌ "${missingName}" still NOT found in CRM`);
                        missingContactsReport.push(`❌ ${missingName}: MISSING`);
                    }
                });

                console.log('📋 MISSING CONTACTS REPORT:');
                missingContactsReport.forEach(report => console.log(report));

                // Show all CRM contacts for verification
                console.log('📞 ALL CONTACTS IN CRM:');
                crmContacts.forEach(contact => {
                    console.log(`  - ${contact.firstName} ${contact.lastName} (${contact.email})`);
                });

                showToast(`Sync completed! Added ${syncedContacts} contacts and ${syncedDeals} deals.`, 'check-circle', 'text-green-400');
                
                // Restore warnings
                restoreWarnings();

            } catch (error) {
                console.error('❌ Error during full CRM sync:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    user: auth.currentUser?.email || 'unknown',
                    timestamp: new Date().toISOString()
                });

                if (error.message?.includes('permission-denied')) {
                    showToast('Permission denied. Please check your account permissions.', 'alert-circle', 'text-red-400');
                } else if (error.message?.includes('unavailable')) {
                    showToast('Service temporarily unavailable. Please try again later.', 'alert-circle', 'text-red-400');
                } else {
                    showToast('Failed to sync invoices to CRM. Check console for details.', 'alert-circle', 'text-red-400');
                }
                
                // Restore warnings even on error
                restoreWarnings();
            }
        }

        // Suppress common warnings during sync
        const originalWarn = console.warn;
        const originalError = console.error;
        
        window.suppressWarnings = function() {
            console.warn = function(...args) {
                // Only suppress Firebase warnings, not important ones
                const message = args.join(' ');
                if (message.includes('Firebase') || 
                    message.includes('deprecated') || 
                    message.includes('experimental') ||
                    message.includes('Warning') ||
                    message.includes('warn') ||
                    message.includes('console messages are not shown')) {
                    return; // Suppress these warnings
                }
                originalWarn.apply(console, args);
            };
        };
        
        window.restoreWarnings = function() {
            console.warn = originalWarn;
            console.error = originalError;
        };

        // Make sync function globally available
        window.syncAllInvoicesToCrm = syncAllInvoicesToCrm;

        // Function to remove duplicate contacts
        window.removeDuplicateContacts = async function() {
            console.log('🧹 REMOVING DUPLICATE CONTACTS');
            console.log('=============================');
            
            if (!currentUserId) {
                console.error('❌ No current user ID found');
                return;
            }

            try {
                // Get all contacts
                const contactsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                const contactsSnap = await getDocs(contactsRef);
                const allContacts = contactsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log(`Found ${allContacts.length} total contacts before cleanup`);
                
                // Group contacts by email and name combination
                const contactGroups = {};
                allContacts.forEach(contact => {
                    const key = `${contact.email}-${contact.firstName}-${contact.lastName}`.toLowerCase();
                    if (!contactGroups[key]) {
                        contactGroups[key] = [];
                    }
                    contactGroups[key].push(contact);
                });
                
                // Find duplicates
                const duplicates = [];
                const keepers = [];
                
                Object.values(contactGroups).forEach(group => {
                    if (group.length > 1) {
                        console.log(`Found ${group.length} duplicates for: ${group[0].firstName} ${group[0].lastName} (${group[0].email})`);
                        duplicates.push(...group.slice(1)); // Keep first, mark rest as duplicates
                        keepers.push(group[0]); // Keep the first one
                    } else {
                        keepers.push(group[0]); // No duplicates, keep it
                    }
                });
                
                console.log(`Found ${duplicates.length} duplicate contacts to remove`);
                console.log(`Keeping ${keepers.length} unique contacts`);
                
                // Delete duplicate contacts
                for (const duplicate of duplicates) {
                    try {
                        const duplicateRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, duplicate.id);
                        await deleteDoc(duplicateRef);
                        console.log(`✅ Deleted duplicate: ${duplicate.firstName} ${duplicate.lastName} (${duplicate.email})`);
                    } catch (error) {
                        console.error(`❌ Failed to delete duplicate ${duplicate.id}:`, error);
                    }
                }
                
                console.log(`🧹 Cleanup complete! Removed ${duplicates.length} duplicates`);
                console.log(`📊 Final count: ${keepers.length} unique contacts`);
                
                // Refresh the CRM dashboard
                await loadCrmDashboard();
                
            } catch (error) {
                console.error('❌ Cleanup failed:', error);
            }
        };

        // Diagnostic function to check CRM data
        window.diagnoseCrmData = async function() {
            console.log('🔍 CRM DIAGNOSTIC TOOL');
            console.log('====================');
            
            if (!currentUserId) {
                console.error('❌ No current user ID found');
                return;
            }

            try {
                // 1. Check all invoices in the system
                console.log('\n📄 STEP 1: Checking all invoices...');
                const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                const invoicesSnap = await getDocs(invoicesRef);
                const allInvoices = invoicesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log(`Found ${allInvoices.length} total invoices:`);
                allInvoices.forEach((inv, i) => {
                    console.log(`  ${i + 1}. ${inv.clientName} (${inv.clientEmail}) - $${inv.amount || 0}`);
                });

                // 2. Check all contacts in CRM
                console.log('\n👥 STEP 2: Checking all CRM contacts...');
                const contactsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`);
                const contactsSnap = await getDocs(contactsRef);
                const allContacts = contactsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log(`Found ${allContacts.length} total contacts:`);
                allContacts.forEach((contact, i) => {
                    console.log(`  ${i + 1}. ${contact.firstName} ${contact.lastName} (${contact.email}) [ID: ${contact.id}]`);
                });

                // 3. Check for missing contacts
                console.log('\n🔍 STEP 3: Checking for missing contacts...');
                const missingNames = ['John Doeeeey', 'Neew new', 'THURSDD Dayyy', 'Thursaday Mannn', 'Thursday Test', 'Thursday333', 'dfdf', 'due today'];
                
                missingNames.forEach(name => {
                    const invoiceExists = allInvoices.some(inv => 
                        inv.clientName && inv.clientName.includes(name)
                    );
                    const contactExists = allContacts.some(contact => 
                        (contact.firstName && contact.firstName.includes(name)) ||
                        (contact.lastName && contact.lastName.includes(name)) ||
                        (contact.email && contact.email.includes(name))
                    );
                    
                    console.log(`  "${name}": Invoice=${invoiceExists ? '✅' : '❌'}, Contact=${contactExists ? '✅' : '❌'}`);
                });

                // 4. Check for contacts with placeholder emails
                console.log('\n📧 STEP 4: Checking for placeholder emails...');
                const placeholderContacts = allContacts.filter(contact => 
                    contact.email && contact.email.includes('placeholder.local')
                );
                console.log(`Found ${placeholderContacts.length} contacts with placeholder emails:`);
                placeholderContacts.forEach(contact => {
                    console.log(`  - ${contact.firstName} ${contact.lastName} (${contact.email})`);
                });

                // 5. Check for contacts with missing emails
                console.log('\n❌ STEP 5: Checking for contacts with missing emails...');
                const noEmailContacts = allContacts.filter(contact => 
                    !contact.email || contact.email === ''
                );
                console.log(`Found ${noEmailContacts.length} contacts with missing emails:`);
                noEmailContacts.forEach(contact => {
                    console.log(`  - ${contact.firstName} ${contact.lastName} (ID: ${contact.id})`);
                });

                // 6. Summary
                console.log('\n📊 DIAGNOSTIC SUMMARY:');
                console.log(`  Total Invoices: ${allInvoices.length}`);
                console.log(`  Total Contacts: ${allContacts.length}`);
                console.log(`  Contact-to-Invoice Ratio: ${((allContacts.length / allInvoices.length) * 100).toFixed(1)}%`);
                console.log(`  Placeholder Emails: ${placeholderContacts.length}`);
                console.log(`  Missing Emails: ${noEmailContacts.length}`);

            } catch (error) {
                console.error('❌ Diagnostic failed:', error);
            }
        };

        // Function to check specific invoice data for missing contacts
        window.checkMissingContactData = async function() {
            console.log('🔍 CHECKING MISSING CONTACT DATA');
            console.log('===============================');
            
            if (!currentUserId) {
                console.error('❌ No current user ID found');
                return;
            }

            try {
                const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                const invoicesSnap = await getDocs(invoicesRef);
                const allInvoices = invoicesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const missingNames = ['John Doeeeey', 'Neew new', 'THURSDD Dayyy', 'Thursaday Mannn', 'Thursday Test', 'Thursday333', 'dfdf', 'due today'];
                
                console.log('\n📋 DETAILED INVOICE DATA FOR MISSING CONTACTS:');
                missingNames.forEach(name => {
                    const matchingInvoices = allInvoices.filter(inv => 
                        inv.clientName && inv.clientName.includes(name)
                    );
                    
                    if (matchingInvoices.length > 0) {
                        console.log(`\n✅ "${name}" - Found ${matchingInvoices.length} invoice(s):`);
                        matchingInvoices.forEach((inv, i) => {
                            console.log(`  Invoice ${i + 1}:`, {
                                id: inv.id,
                                clientName: inv.clientName,
                                clientEmail: inv.clientEmail,
                                clientPhone: inv.clientPhone,
                                amount: inv.amount,
                                dueDate: inv.dueDate,
                                status: inv.status,
                                hasEmail: !!inv.clientEmail,
                                emailValid: inv.clientEmail && inv.clientEmail.includes('@'),
                                nameValid: inv.clientName && inv.clientName.trim().length > 0
                            });
                        });
                    } else {
                        console.log(`\n❌ "${name}" - No invoices found`);
                    }
                });

            } catch (error) {
                console.error('❌ Check failed:', error);
            }
        };

        // Helper function to update CRM stats consistently
        function updateCrmStats(contacts, deals, activities) {
            const totalContactsEl = document.getElementById('totalContacts');
            const activeDealsEl = document.getElementById('activeDeals');
            const totalActivitiesEl = document.getElementById('totalActivities');
            
            if (totalContactsEl) totalContactsEl.textContent = contacts.length;
            if (activeDealsEl) activeDealsEl.textContent = deals.filter(d => d.status === 'open').length;
            if (totalActivitiesEl) totalActivitiesEl.textContent = activities.length;
            
            console.log(`📊 Updated CRM stats - Contacts: ${contacts.length}, Active Deals: ${deals.filter(d => d.status === 'open').length}, Activities: ${activities.length}`);
        }

        function renderContactsTable(contacts) {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';

            console.log('Rendering contacts table with:', contacts.length, 'contacts');
            console.log('Contacts data:', contacts);

            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No contacts found</td></tr>';
                return;
            }
            
            // Sort contacts alphabetically by first name, then last name
            const sortedContacts = contacts.sort((a, b) => {
                const nameA = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
                const nameB = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            console.log('Sorted contacts alphabetically:', sortedContacts.map(c => `${c.firstName} ${c.lastName}`));
            
            sortedContacts.forEach(contact => {
                console.log('Processing contact:', contact);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${contact.firstName} ${contact.lastName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.phone || '—'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${contact.createdAt ? new Date(contact.createdAt.seconds ? contact.createdAt.seconds * 1000 : contact.createdAt).toLocaleDateString() : '—'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderDealsTable(deals) {
            const tbody = document.getElementById('dealsTableBody');
            tbody.innerHTML = '';
            
            if (deals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No deals found</td></tr>';
                return;
            }
            
            deals.forEach(deal => {
                const statusBadge = deal.status === 'closed-won' ? 
                    '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Closed Won</span>' :
                    '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Open</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${deal.invoiceNumber}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${parseFloat(deal.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${deal.dueDate ? new Date(deal.dueDate).toLocaleDateString() : '—'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${deal.contactEmail}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderActivitiesTable(activities) {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = '';

            if (activities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="text-gray-400">
                                    <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">No activities yet</h4>
                                    <p class="text-gray-500 mb-4">Start tracking your invoice interactions and customer communications.</p>
                                    <button onclick="openActivityModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Your First Activity
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by timestamp (newest first)
            activities.sort((a, b) => {
                const aTime = a.timestamp ? (a.timestamp.seconds ? a.timestamp.seconds * 1000 : a.timestamp) : 0;
                const bTime = b.timestamp ? (b.timestamp.seconds ? b.timestamp.seconds * 1000 : b.timestamp) : 0;
                return bTime - aTime;
            });
            
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">${activity.type}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${activity.note}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.contactEmail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${activity.timestamp ? new Date(activity.timestamp.seconds ? activity.timestamp.seconds * 1000 : activity.timestamp).toLocaleString() : '—'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Sync Existing Invoices Function
        async function syncExistingInvoices() {
            if (!currentUserId) {
                showToast('Please sign in first', 'alert-circle', 'text-red-400');
                return;
            }

            try {
                showToast('Syncing existing invoices...', 'refresh-cw', 'text-blue-400');
                
                // Get all existing invoices
                const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                const invoicesSnap = await getDocs(invoicesRef);
                const invoices = invoicesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log('Found existing invoices:', invoices.length);
                
                let syncedCount = 0;
                
                for (const invoice of invoices) {
                    try {
                        // Create/update contact
                        const contactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, invoice.clientEmail);
                        await setDoc(contactRef, {
                            email: invoice.clientEmail,
                            firstName: (invoice.clientName || '').split(' ')[0] || invoice.clientName,
                            lastName: (invoice.clientName || '').split(' ').slice(1).join(' ') || '',
                            phone: invoice.clientPhone || '',
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                        
                        // Create/update deal
                        const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, invoice.id);
                        await setDoc(dealRef, {
                            invoiceId: invoice.id,
                            invoiceNumber: (invoice.id || '').slice(-6).toUpperCase(),
                            amount: invoice.amount,
                            dueDate: invoice.dueDate,
                            description: invoice.description || '',
                            contactEmail: invoice.clientEmail,
                            status: invoice.status === 'paid' ? 'closed-won' : 'open',
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                        
                        syncedCount++;
                        
                    } catch (error) {
                        console.error('Error syncing invoice:', invoice.id, error);
                    }
                }
                
                showToast(`Successfully synced ${syncedCount} invoices to CRM!`, 'check-circle', 'text-green-400');
                console.log(`Synced ${syncedCount} invoices to CRM`);
                
            } catch (error) {
                console.error('Error syncing existing invoices:', error);
                showToast('Failed to sync existing invoices', 'alert-circle', 'text-red-400');
            }
        }

        // Add event listener for manage billing button
        document.addEventListener('DOMContentLoaded', () => {
            const manageBillingBtn = document.getElementById('manageBillingBtn');
            if (manageBillingBtn) {
                manageBillingBtn.addEventListener('click', openBillingPortal);
            }
            
            const cancelSubscriptionBtn = document.getElementById('cancelSubscriptionBtn');
            if (cancelSubscriptionBtn) {
                cancelSubscriptionBtn.addEventListener('click', cancelSubscription);
            }
            
            const viewPlansBtn = document.getElementById('viewPlansBtn');
            if (viewPlansBtn) {
                viewPlansBtn.addEventListener('click', () => showView('pricingView'));
            }

            // CRM Button handlers
            const connectBtn = document.getElementById('connectCrmBtn');
            const disconnectBtn = document.getElementById('disconnectCrmBtn');
            const syncBtn = document.getElementById('syncNowBtn');
            const viewBtn = document.getElementById('viewCrmBtn');

            if (connectBtn) connectBtn.addEventListener('click', async () => {
                try {
                    if (!auth.currentUser) return showToast('Sign in first', 'alert-circle', 'text-red-400');
                    if (userProfile.plan !== 'business') return showToast('CRM is a Business feature', 'gem', 'text-amber-500');

                    // LOCAL TEST: Simulate CRM connection without Netlify functions
                    console.log('Connecting CRM locally...');
                    
                    // Update user profile directly in Firestore
                    const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                    await updateDoc(profileDocRef, {
                        'crm.provider': 'local',
                        'crm.connected': true,
                        'crm.lastSyncedAt': new Date()
                    });
                    
                    // Refresh the UI
                    await refreshCrmStatus();
                    showToast('CRM connected successfully!', 'check-circle', 'text-green-400');
                    
                } catch (e) {
                    console.error(e);
                    showToast('Failed to connect CRM', 'alert-circle', 'text-red-400');
                }
            });

            if (disconnectBtn) disconnectBtn.addEventListener('click', async () => {
                try {
                    // LOCAL VERSION: Disconnect CRM directly in Firestore
                    const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                    await updateDoc(profileDocRef, {
                        'crm.connected': false,
                        'crm.provider': null,
                        'crm.lastSyncedAt': null
                    });
                    
                    await refreshCrmStatus();
                    showToast('CRM disconnected', 'check-circle', 'text-green-400');
                } catch (e) {
                    console.error(e);
                    showToast('Failed to disconnect', 'alert-circle', 'text-red-400');
                }
            });

            if (syncBtn) syncBtn.addEventListener('click', async () => {
                try {
                    console.log('Sync Now button clicked');
                    await syncExistingInvoices();
                } catch (e) {
                    console.error('Error syncing existing invoices:', e);
                    showToast('Failed to sync existing invoices', 'alert-circle', 'text-red-400');
                }
            });

            if (viewBtn) viewBtn.addEventListener('click', async () => {
                try {
                    console.log('View CRM Data button clicked');
                    showView('crmView');
                    await loadCrmDashboard();
                } catch (e) {
                    console.error('Error in view button click:', e);
                    showToast('Failed to load CRM dashboard', 'alert-circle', 'text-red-400');
                }
            });

        });

        const processAISchedules = async () => {
            try {
                console.log('processAISchedules called for user:', currentUserId);

                // Get AI schedule settings
                const scheduleRef = doc(db, `artifacts/${appId}/users/${currentUserId}/aiSchedule`, 'settings');
                const scheduleSnap = await getDoc(scheduleRef);

                console.log('AI schedule settings:', scheduleSnap.exists() ? scheduleSnap.data() : 'No settings found');

                if (!scheduleSnap.exists() || !scheduleSnap.data().enabled) {
                    console.log('AI scheduling not enabled or no settings found');
                return;
            }

                const settings = scheduleSnap.data();

                // Get all unpaid invoices
                const invoicesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/invoices`);
                const unpaidInvoicesSnap = await getDocs(query(invoicesRef, where('status', 'in', ['active', 'unpaid'])));

                const now = new Date();
                const remindersToSend = [];

                unpaidInvoicesSnap.forEach(doc => {
                    const invoice = { id: doc.id, ...doc.data() };
                    const dueDate = new Date(invoice.dueDate);

                    // Check each reminder type
                    settings.reminders.forEach(reminderType => {
                        let reminderDate;
                        let reminderKey;

                        switch (reminderType) {
                            case '7days':
                                reminderDate = new Date(dueDate.getTime() - (7 * 24 * 60 * 60 * 1000));
                                reminderKey = 'reminder7days';
                                break;
                            case '3days':
                                reminderDate = new Date(dueDate.getTime() - (3 * 24 * 60 * 60 * 1000));
                                reminderKey = 'reminder3days';
                                break;
                            case 'due':
                                reminderDate = dueDate;
                                reminderKey = 'reminderDue';
                                break;
                            case 'overdue':
                                // Check if invoice is overdue and hasn't been reminded recently
                                if (now > dueDate) {
                                    const lastOverdueReminder = invoice.reminderOverdueSent;
                                    const daysSinceLastReminder = lastOverdueReminder ? 
                                        Math.floor((now - new Date(lastOverdueReminder)) / (24 * 60 * 60 * 1000)) : 999;
                                    
                                    // Send reminder immediately if overdue and no recent reminder, or weekly after
                                    if (!lastOverdueReminder || daysSinceLastReminder >= 7) {
                                        reminderDate = now;
                                        reminderKey = 'reminderOverdue';
                                    }
                                }
                                break;
                        }

                        if (reminderDate && !invoice[reminderKey + 'Sent']) {
                            // Check if it's time to send this reminder (within last 24 hours for scheduled, or immediately for overdue)
                            const timeDiff = Math.abs(now - reminderDate);
                            const hoursDiff = timeDiff / (1000 * 60 * 60);

                            if (reminderType === 'overdue' || hoursDiff <= 24) {
                                remindersToSend.push({
                                    invoice: invoice,
                                    reminderType: reminderType,
                                    reminderKey: reminderKey,
                                    reminderDate: reminderDate
                                });
                            }
                        }
                    });
                });

                // Send reminders (with quota check)
                for (const reminder of remindersToSend) {
                    // Check if user has remaining quota before sending
                    if (userProfile.sendsThisMonth >= PLAN_LIMITS[userProfile.plan]) {
                        console.log(`AI reminder not sent for invoice ${reminder.invoice.id} - Plan limit reached (${userProfile.sendsThisMonth}/${PLAN_LIMITS[userProfile.plan]})`);
                        continue;
                    }

                    console.log(`Processing AI reminder: ${reminder.invoice.id} (${reminder.reminderType}) - Client: ${reminder.invoice.clientName}, Email: ${reminder.invoice.clientEmail}`);
                    console.log(`Current usage before sending: ${userProfile.sendsThisMonth}/${PLAN_LIMITS[userProfile.plan]}`);
                    
                    await sendAIReminder(reminder.invoice, reminder.reminderType, settings.customMessage);

                                            // Mark reminder as sent
                        const invoiceRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, reminder.invoice.id);
                        
                        // Create message log entry
                        const logEntry = {
                            timestamp: new Date().toISOString(),
                            method: 'AI Reminder',
                            content: `AI reminder sent (${reminder.reminderType}) to ${reminder.invoice.clientEmail} – Amount: $${formatAmountForEmail(reminder.invoice.amount)}`
                        };
                        
                        // Determine if we should update status to 'sent' or keep current status
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const due = new Date(reminder.invoice.dueDate + 'T00:00:00');
                        const isOverdue = due < today;
                        
                        const updateData = {
                            [reminder.reminderKey + 'Sent']: new Date(),
                            messageLog: arrayUnion(logEntry)
                        };
                        
                        // Only change status to 'sent' if not overdue
                        if (!isOverdue) {
                            updateData.status = 'sent';
                        }
                        
                        await updateDoc(invoiceRef, updateData);
                }

                if (remindersToSend.length > 0) {
                    console.log(`Sent ${remindersToSend.length} AI reminders`);
                    // Update UI immediately after sending reminders
                    updateSubscriptionStatusUI();
                } else {
                    console.log('No AI reminders to send at this time');
                }

            } catch (error) {
                console.error('Error processing AI schedules:', error);
            }
        };

        const sendAIReminder = async (invoice, reminderType, customMessage) => {
            try {
                const reminderMessages = {
                    '7days': 'This is a gentle reminder that your invoice is due in 7 days.',
                    '3days': 'Urgent: Your invoice is due in 3 days.',
                    'due': 'Your invoice is due today.',
                    'overdue': 'Your invoice is overdue. Please arrange payment as soon as possible.'
                };

                const message = customMessage || reminderMessages[reminderType];

                const templateParams = {
                    to_name: invoice.clientName || invoice.customerName,
                    to_email: invoice.clientEmail,
                    invoice_amount: `$${formatAmountForEmail(invoice.amount)}`,
                    due_date: formatDateForEmail(invoice.dueDate),
                    invoice_description: invoice.description || 'Invoice',
                    message: message
                };

                // Send email using EmailJS
                if (typeof emailjs !== 'undefined' && EMAILJS_CONFIG.serviceId && EMAILJS_CONFIG.templateId) {
                    console.log(`Sending AI reminder email to ${invoice.clientEmail} for invoice ${invoice.id}: ${reminderType}`);
                    console.log('Email template params:', templateParams);

                    try {
                        const result = await emailjs.send(
                            EMAILJS_CONFIG.serviceId,
                            EMAILJS_CONFIG.templateId,
                            templateParams
                        );
                        console.log(`AI reminder email sent successfully for invoice ${invoice.id}: ${reminderType}`, result);
                        
                        // Update send count only if email was sent successfully
                        const newSendCount = userProfile.sendsThisMonth + 1;
                        await updateUserProfile({ sendsThisMonth: newSendCount });

                        // Log the usage update
                        console.log(`AI reminder sent - Updated usage: ${newSendCount}/${PLAN_LIMITS[userProfile.plan]}`);
                        
                        // Show success notification
                        showToast(`AI reminder sent to ${invoice.clientName}!`, 'check-circle', 'text-green-400');

                        // CRM: log AI reminder (Business only) - LOCAL VERSION
                        try {
                            if (userProfile.plan === 'business') {
                                // Check if CRM is connected
                                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                                const profileSnap = await getDoc(profileDocRef);
                                const profileData = profileSnap.data();
                                const crm = profileData?.crm;
                                
                                if (crm && crm.connected) {
                                    // Create/update contact
                                    const contactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, invoice.clientEmail);
                                    await setDoc(contactRef, {
                                        email: invoice.clientEmail,
                                        firstName: (invoice.clientName || '').split(' ')[0] || invoice.clientName,
                                        lastName: (invoice.clientName || '').split(' ').slice(1).join(' ') || '',
                                        phone: invoice.clientPhone || '',
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    }, { merge: true });
                                    
                                    // Create/update deal
                                    const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, invoice.id);
                                    await setDoc(dealRef, {
                                        invoiceId: invoice.id,
                                        invoiceNumber: (invoice.id || '').slice(-6).toUpperCase(),
                                        amount: invoice.amount,
                                        dueDate: invoice.dueDate,
                                        description: invoice.description || '',
                                        contactEmail: invoice.clientEmail,
                                        status: 'open',
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    }, { merge: true });
                                    
                                    // Create activity
                                    const activityRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmActivities`);
                                    await addDoc(activityRef, {
                                        contactEmail: invoice.clientEmail,
                                        dealId: invoice.id,
                                        type: 'reminder',
                                        note: `AI reminder (${reminderType})`,
                                        channel: 'email',
                                        timestamp: new Date(),
                                        createdAt: new Date()
                                    });
                                    
                                    console.log('CRM AI reminder activity logged locally');
                                }
                            }
                        } catch (e) {
                            console.warn('CRM reminder_log (AI) failed:', e);
                        }
                        
                    } catch (emailError) {
                        console.error(`Failed to send AI reminder email for invoice ${invoice.id}:`, emailError);
                        showToast(`Failed to send email reminder: ${emailError.message}`, 'alert-circle', 'text-red-400');
                        return; // Don't update usage if email failed
                    }
                } else {
                    console.error(`AI reminder not sent - EmailJS not properly configured:`, {
                        emailjs: typeof emailjs,
                        serviceId: EMAILJS_CONFIG.serviceId,
                        templateId: EMAILJS_CONFIG.templateId,
                        publicKey: EMAILJS_CONFIG.publicKey
                    });
                    showToast('AI reminder not sent - EmailJS not configured', 'alert-circle', 'text-red-400');
                    return; // Don't update usage if EmailJS is not configured
                }

            } catch (error) {
                console.error('Error sending AI reminder:', error);
            }
        };

        const stopAISequenceForInvoice = async (invoiceId) => {
            try {
                // Clear all reminder sent flags for this invoice
                const invoiceRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, invoiceId);
                await updateDoc(invoiceRef, {
                    reminder7daysSent: null,
                    reminder3daysSent: null,
                    reminderDueSent: null,
                    reminderOverdueSent: null
                });
                console.log(`AI sequence stopped for invoice ${invoiceId}`);
            } catch (error) {
                console.error('Error stopping AI sequence:', error);
            }
        };

        // Function to automatically send AI reminders for newly created invoices
        // This checks if the new invoice matches any AI schedule criteria and sends appropriate reminders
        const checkAndSendAIReminderForNewInvoice = async (invoice) => {
            try {
                console.log('checkAndSendAIReminderForNewInvoice called for invoice:', invoice.id);

                // Only process for Pro/Business users
                if (!userProfile || (userProfile.plan !== 'pro' && userProfile.plan !== 'business')) {
                    console.log('Skipping AI reminder - user not eligible (plan:', userProfile?.plan, ')');
                    return;
                }

                // Check if user has AI scheduling enabled
                const scheduleRef = doc(db, `artifacts/${appId}/users/${currentUserId}/aiSchedule`, 'settings');
                const scheduleSnap = await getDoc(scheduleRef);

                console.log('AI schedule settings loaded for new invoice:', scheduleSnap.exists() ? scheduleSnap.data() : 'No settings found');

                if (!scheduleSnap.exists()) {
                    console.log('No AI schedule settings found');
                    return;
                }

                const settings = scheduleSnap.data();
                if (!settings.enabled || !settings.reminders || settings.reminders.length === 0) {
                    console.log('AI scheduling not enabled or no reminders configured');
                    return;
                }

                const now = new Date();
                const dueDate = new Date(invoice.dueDate);

                // Check each reminder type to see if it matches the new invoice
                let reminderSent = false;

                for (const reminderType of settings.reminders) {
                    if (reminderSent) break; // Only send one reminder per new invoice

                    let shouldSendReminder = false;
                    let reminderMessage = '';

                    // Calculate date differences in days
                    const dueDateOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
                    const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const daysUntilDue = Math.ceil((dueDateOnly - todayOnly) / (24 * 60 * 60 * 1000));

                    switch (reminderType) {
                        case '7days':
                            if (daysUntilDue === 7) {
                                shouldSendReminder = true;
                                reminderMessage = 'This is a gentle reminder that your invoice is due in 7 days.';
                            }
                            break;

                        case '3days':
                            if (daysUntilDue === 3) {
                                shouldSendReminder = true;
                                reminderMessage = 'Urgent: Your invoice is due in 3 days.';
                            }
                            break;

                        case 'due':
                            if (daysUntilDue === 0) { // Due today
                                shouldSendReminder = true;
                                reminderMessage = 'Your invoice is due today.';
                            }
                            break;

                        case 'overdue':
                            if (daysUntilDue < 0) { // Overdue
                                shouldSendReminder = true;
                                reminderMessage = 'Your invoice is overdue. Please arrange payment as soon as possible.';
                            }
                            break;
                    }

                    if (shouldSendReminder) {
                        // Check if user has remaining quota
                        if (userProfile.sendsThisMonth >= PLAN_LIMITS[userProfile.plan]) {
                            console.log(`AI reminder not sent for new invoice - Plan limit reached`);
                            showToast('AI reminder not sent - monthly limit reached', 'alert-circle', 'text-amber-500');
                            return;
                        }

                        console.log(`Sending immediate AI reminder for new invoice: ${reminderType} (due in ${daysUntilDue} days)`);
                        console.log(`Invoice details - Client: ${invoice.clientName}, Email: ${invoice.clientEmail}, Amount: $${invoice.amount}`);

                        // Send the reminder immediately
                        console.log(`About to send AI reminder for invoice ${invoice.id} - Current usage: ${userProfile.sendsThisMonth}/${PLAN_LIMITS[userProfile.plan]}`);
                        await sendAIReminder(invoice, reminderType, settings.customMessage || reminderMessage);

                        // Mark reminder as sent in Firestore
                        const reminderKey = `reminder${reminderType.charAt(0).toUpperCase() + reminderType.slice(1)}Sent`;
                        const invoiceRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, invoice.id);
                        
                        // Create message log entry
                        const logEntry = {
                            timestamp: new Date().toISOString(),
                            method: 'AI Reminder',
                            content: `AI reminder sent (${reminderType}) to ${invoice.clientEmail} – Amount: $${formatAmountForEmail(invoice.amount)}`
                        };
                        
                        // Determine if we should update status to 'sent' or keep current status
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const due = new Date(invoice.dueDate + 'T00:00:00');
                        const isOverdue = due < today;
                        
                        const updateData = {
                            [reminderKey]: new Date(),
                            messageLog: arrayUnion(logEntry)
                        };
                        
                        // Only change status to 'sent' if not overdue
                        if (!isOverdue) {
                            updateData.status = 'sent';
                        }
                        
                        await updateDoc(invoiceRef, updateData);

                        // Update UI after sending AI reminder (usage count already updated by sendAIReminder)
                        updateSubscriptionStatusUI();

                        console.log(`AI reminder sent successfully for new invoice - Usage count updated by sendAIReminder function`);

                        // Show notification to user
                        showToast(`AI reminder sent for new invoice!`, 'zap', 'text-purple-400');

                        reminderSent = true;
                        break; // Only send one reminder type per new invoice
                    }
                }

            } catch (error) {
                console.error('Error checking AI reminders for new invoice:', error);
            }
        };
        
        function initializeUI() {
            // Initialize default due date
            setDefaultDueDate();

            // Add invoice button event listeners
            addInvoiceBtnEmpty.addEventListener('click', () => {
                if (!currentUserId) {
                    showToast('Please sign in to create invoices', 'alert-circle', 'text-red-400');
                    openModal(document.getElementById('signInModal'));
                    return;
                }
                openModal(invoiceModal);
            });
            
            addInvoiceBtnList.addEventListener('click', () => {
                if (!currentUserId) {
                    showToast('Please sign in to create invoices', 'alert-circle', 'text-red-400');
                    openModal(document.getElementById('signInModal'));
                    return;
                }
                openModal(invoiceModal);
            });
        
            // Continue with other initialization code

        // --- Modal & View Navigation ---

        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));
        

        document.querySelectorAll('.upgrade-link').forEach(btn => btn.addEventListener('click', () => { showView('pricingView'); }));
        document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('mainView'));
        document.getElementById('backToDashboardFromDetailBtn').addEventListener('click', () => showView('mainView'));
        
        document.getElementById('viewPricingBtn').addEventListener('click', () => {
            showView('pricingView');
            // Scroll to top when switching to pricing view
            window.scrollTo(0, 0);
        });

        document.querySelectorAll('.select-plan-btn').forEach(btn => {
            btn.addEventListener('click', () => showView('mainView'));
        });

        // Activity Form Handler
        const activityForm = document.getElementById('activityForm');
        if (activityForm) {
            activityForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const activityType = document.getElementById('activityType').value;
                const contactEmail = document.getElementById('contactEmail').value;
                const activityNote = document.getElementById('activityNote').value;
                const activityDate = document.getElementById('activityDate').value;

                if (!activityType || !contactEmail || !activityNote || !activityDate) {
                    showToast('Please fill in all fields', 'error');
                    return;
                }

                try {
                    const activityRef = collection(db, `artifacts/${appId}/users/${currentUserId}/crmActivities`);

                    await addDoc(activityRef, {
                        contactEmail: contactEmail,
                        type: activityType,
                        note: activityNote,
                        channel: activityType === 'email' ? 'email' : activityType === 'call' ? 'phone' : 'manual',
                        timestamp: new Date(activityDate),
                        createdAt: new Date()
                    });

                    showToast('Activity added successfully!', 'success');

                    // Close modal
                    closeModal(document.getElementById('activityModal'));

                    // Refresh activities if we're on the CRM view
                    if (document.getElementById('crmView').classList.contains('hidden') === false) {
                        loadCrmDashboard();
                    }

                } catch (error) {
                    console.error('Error adding activity:', error);
                    showToast('Error adding activity. Please try again.', 'error');
                }
            });
        }

        // Email configuration
        const emailjsServiceIdInput = document.getElementById('emailjsServiceId');
        const emailjsTemplateIdInput = document.getElementById('emailjsTemplateId');
        const emailjsPublicKeyInput = document.getElementById('emailjsPublicKey');
        const testEmailBtn = document.getElementById('testEmailBtn');
        const saveEmailConfigBtn = document.getElementById('saveEmailConfigBtn');

        // Load saved EmailJS configuration
        const savedConfig = localStorage.getItem('emailjs_config');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);

                // Populate form fields
                if (emailjsServiceIdInput) emailjsServiceIdInput.value = config.serviceId || '';
                if (emailjsTemplateIdInput) emailjsTemplateIdInput.value = config.templateId || '';
                if (emailjsPublicKeyInput) emailjsPublicKeyInput.value = config.publicKey || '';

                // Re-initialize EmailJS if we have a valid public key
                if (EMAILJS_CONFIG.publicKey && EMAILJS_CONFIG.publicKey !== 'user_def456') {
                    emailjs.init(EMAILJS_CONFIG.publicKey);
                }
            } catch (error) {
                console.error('Error loading saved EmailJS configuration:', error);
            }
        }

            // Add AI scheduling event listeners
            const setupAIScheduleBtn = document.getElementById('setupAIScheduleBtn');
            const saveAIScheduleBtn = document.getElementById('saveAIScheduleBtn');
            const aiScheduleModal = document.getElementById('aiScheduleModal');

            if (setupAIScheduleBtn) {
                setupAIScheduleBtn.addEventListener('click', async () => {
                    if (!currentUserId) {
                        showToast('Please sign in to set up AI scheduling', 'alert-circle', 'text-red-400');
                        openModal(document.getElementById('signInModal'));
                        return;
                    }
                    await loadAIScheduleSettings();
                    openModal(aiScheduleModal);
                });
            }

            if (saveAIScheduleBtn) {
                saveAIScheduleBtn.addEventListener('click', saveAIScheduleSettings);
            }

            // Close modal on cancel button click
            if (aiScheduleModal) {
                const cancelBtns = aiScheduleModal.querySelectorAll('.cancel-btn');
                cancelBtns.forEach(btn => {
                    btn.addEventListener('click', () => closeModal(aiScheduleModal));
                });
            }

            // Initialize AI schedule status
            updateAIScheduleStatus();
        
        // Amount field comma formatter - adds commas for thousands, millions, etc.
        const amountInput = document.getElementById('amount');
        if (amountInput) {
            let isFormatting = false; // Prevent infinite loop
            
            amountInput.addEventListener('input', (e) => {
                if (isFormatting) return; // Skip if we're already formatting
                
                isFormatting = true;
                
                // Get cursor position
                const cursorPos = e.target.selectionStart;
                const oldValue = e.target.value;
                
                // Remove any existing commas and non-numeric characters except decimal point
                let value = e.target.value.replace(/[^\d.]/g, '');
                
                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Format the whole number part with commas
                if (parts[0]) {
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
                
                // Reconstruct the value
                const formattedValue = parts.join('.');
                
                // Update the input value if it changed
                if (formattedValue !== oldValue) {
                    e.target.value = formattedValue;
                    
                    // Adjust cursor position to account for added commas
                    const commaDiff = (formattedValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
                    const newCursorPos = cursorPos + commaDiff;
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }
                
                isFormatting = false;
            });
            
            // Also handle paste events to format pasted amounts
            amountInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                
                // Clean and format the pasted text
                let value = pastedText.replace(/[^\d.]/g, '');
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                if (parts[0]) {
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
                
                const formattedValue = parts.join('.');
                e.target.value = formattedValue;
            });
        }
        
        } // End of initializeUI function
        
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM fully loaded, initializing UI...');
                // Initialize Firebase first
                if (initializeFirebase()) {
                    setupAuthListeners(); // Set up auth listeners after Firebase is ready
                    initializeUI();
                } else {
                    console.error('Failed to initialize Firebase, UI initialization skipped');
                }
            });
        } else {
            console.log('DOM already loaded, initializing UI...');
            // Initialize Firebase first
            if (initializeFirebase()) {
                setupAuthListeners(); // Set up auth listeners after Firebase is ready
                initializeUI();
            } else {
                console.error('Failed to initialize Firebase, UI initialization skipped');
            }
        }
        
        // Add a fallback for when Firebase is not available
        window.addEventListener('error', (event) => {
            if (event.message.includes('Firebase') || event.message.includes('firebase')) {
                console.error('Firebase-related error detected:', event.error);
                if (!auth) {
                    console.warn('Firebase not available, running in offline mode');
                    // Show a warning to the user
                    setTimeout(() => {
                        if (typeof showToast === 'function') {
                            showToast('Running in offline mode - some features may be limited', 'alert-triangle', 'text-amber-500');
                        }
                    }, 2000);
                }
            }
        });

        // Expose Firebase initialization function globally for debugging
        window.initializeFirebase = initializeFirebase;

        // Helper function to check if EmailJS is properly configured
        function isEmailJSConfigured() {
            return EMAILJS_CONFIG.serviceId &&
                   EMAILJS_CONFIG.templateId &&
                   EMAILJS_CONFIG.publicKey &&
                   EMAILJS_CONFIG.serviceId !== 'service_abc123' &&
                   EMAILJS_CONFIG.templateId !== 'template_xyz789' &&
                   EMAILJS_CONFIG.publicKey !== 'user_def456';
        }
        
        // Send reminder function - uses EmailJS for automatic email sending
        async function sendInstantReminder(invoiceId) {
            console.log('sendInstantReminder called with invoiceId:', invoiceId);

            // Check if EmailJS is configured
            if (!isEmailJSConfigured()) {
                showToast('Email service not configured. Please set up EmailJS in the configuration modal.', 'alert-circle', 'text-red-400');
                openModal(document.getElementById('emailConfigModal'));
                return;
            }

            // Enforce limit
            const userPlan = userProfile.plan;
            console.log('User plan:', userPlan, 'Sends this month:', userProfile.sendsThisMonth);
            if (userProfile.sendsThisMonth >= PLAN_LIMITS[userPlan]) {
                showToast("You've reached your monthly limit. Upgrade to send more!", 'gem', 'text-amber-500');
                showView('pricingView');
                return;
            }

            // Retrieve invoice (from Firestore)
            const invoiceRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, invoiceId);
            const snap = await getDoc(invoiceRef);
            if (!snap.exists()) {
                showToast('Invoice not found.', 'alert-circle', 'text-red-400');
                return;
            }
            const inv = snap.data();
            console.log('Invoice data retrieved:', inv);

            try {
                // Prepare email parameters for EmailJS template
                const emailParams = {
                    to_email: inv.clientEmail,
                    to_name: inv.clientName,
                    from_email: auth.currentUser?.email || 'noreply@invoicereminder.com',
                    from_name: auth.currentUser?.displayName || 'Invoice Reminder Service',
                    invoice_amount: `$${formatAmountForEmail(inv.amount)}`,
                    due_date: formatDateForEmail(inv.dueDate),
                    invoice_description: inv.description || 'Services rendered',
                    message: `Hi ${inv.clientName},

This is a friendly reminder about your outstanding invoice.

Invoice Details:
• Amount: $${formatAmountForEmail(inv.amount)}
• Due Date: ${formatDateForEmail(inv.dueDate)}
• Description: ${inv.description || 'Services rendered'}

Thank you for your business!

Best regards,
Invoice Reminder Service`
                };

                console.log('Sending email with EmailJS...');

                // Send email using EmailJS
                const result = await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    emailParams
                );

                console.log('EmailJS result:', result);

                // Log success
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    method: 'email',
                    content: `Email sent successfully to ${inv.clientEmail} – Amount: $${parseFloat(inv.amount).toFixed(2)}`
                };
                await updateDoc(invoiceRef, {
                    status: 'sent',
                    lastSent: new Date().toISOString(),
                    messageLog: arrayUnion(logEntry)
                });

                // Update usage count
                await updateUserProfile({ sendsThisMonth: userProfile.sendsThisMonth + 1 });
                
                // Refresh local profile to get updated count
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                const profileSnap = await getDoc(profileDocRef);
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                }
                
                showToast(`Email sent successfully to ${inv.clientEmail}!`, 'send', 'text-green-400');
                console.log('EmailJS send completed successfully');

                // CRM: log reminder activity (Business only) - LOCAL VERSION
                try {
                    if (userProfile.plan === 'business') {
                        // Check if CRM is connected
                        const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                        const profileSnap = await getDoc(profileDocRef);
                        const profileData = profileSnap.data();
                        const crm = profileData?.crm;
                        
                        if (crm && crm.connected) {
                            // Create/update contact
                            const contactRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmContacts`, inv.clientEmail);
                            await setDoc(contactRef, {
                                email: inv.clientEmail,
                                firstName: (inv.clientName || '').split(' ')[0] || inv.clientName,
                                lastName: (inv.clientName || '').split(' ').slice(1).join(' ') || '',
                                phone: inv.clientPhone || '',
                                createdAt: new Date(),
                                updatedAt: new Date()
                            }, { merge: true });
                            
                            // Create/update deal
                            const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, invoiceId);
                            await setDoc(dealRef, {
                                invoiceId: invoiceId,
                                invoiceNumber: (invoiceId || '').slice(-6).toUpperCase(),
                                amount: inv.amount,
                                dueDate: inv.dueDate,
                                description: inv.description || '',
                                contactEmail: inv.clientEmail,
                                status: 'open',
                                createdAt: new Date(),
                                updatedAt: new Date()
                            }, { merge: true });
                            
                            // Create activity
                            const activityRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmActivities`);
                            await addDoc(activityRef, {
                                contactEmail: inv.clientEmail,
                                dealId: invoiceId,
                                type: 'reminder',
                                note: 'Manual reminder sent from dashboard',
                                channel: 'email',
                                timestamp: new Date(),
                                createdAt: new Date()
                            });
                            
                            console.log('CRM reminder activity logged locally');
                        }
                    }
                } catch (e) {
                    console.warn('CRM reminder_log failed:', e);
                }

            } catch (error) {
                console.error('Error in sendInstantReminder:', error);
                showToast('Failed to send email: ' + error.message, 'alert-circle', 'text-red-400');
            }
        }

        // Helper function for marking as paid - moved to global scope
        const markAsPaid = async (invoiceId) => {
            try {
                const invoiceDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, invoiceId);
                await updateDoc(invoiceDocRef, { status: 'paid' });

                // Stop AI sequences for this invoice
                await stopAISequenceForInvoice(invoiceId);

                showToast('Invoice marked as paid!', 'check-circle', 'text-green-400');

                // CRM: close deal as won (Business only) - LOCAL VERSION
                try {
                    if (userProfile.plan === 'business') {
                        // Check if CRM is connected
                        const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'data');
                        const profileSnap = await getDoc(profileDocRef);
                        const profileData = profileSnap.data();
                        const crm = profileData?.crm;
                        
                        if (crm && crm.connected) {
                            // Update deal to closed/won
                            const dealRef = doc(db, `artifacts/${appId}/users/${currentUserId}/crmDeals`, invoiceId);
                            await updateDoc(dealRef, {
                                status: 'closed-won',
                                closedAt: new Date(),
                                updatedAt: new Date()
                            });
                            
                            console.log('CRM deal marked as closed-won locally');
                        }
                    }
                } catch (e) {
                    console.warn('CRM invoice_paid failed:', e);
                }
            } catch (error) {
                showToast('Failed to update invoice', 'alert-circle', 'text-red-400');
            }
        };
        



        // Duplicate initializeUI function removed
















        // Phone and amount formatters already defined above

        








        
        // All initialization code already defined above
        // End of initializeUI function

        // Set up periodic AI schedule processing
        setInterval(async () => {
            console.log('Periodic AI schedule check running...');
            if (currentUserId && userProfile && userProfile.plan !== 'free') {
                console.log('Processing AI schedules...');
                await processAISchedules();
            } else {
                console.log('Skipping AI schedule processing - user not eligible or not authenticated');
            }
        }, 60 * 60 * 1000); // Check every hour

        // Note: Authentication event listeners are now set up in setupAuthListeners() 
        // which is called after Firebase initialization to prevent undefined errors

        // Handle invoice list actions (send reminder, mark paid, delete)
        invoiceList.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (action === 'send-reminder') {
                if (currentUserId) {
                    await sendInstantReminder(id);
                } else {
                    showToast('Please sign in to send reminders', 'alert-circle', 'text-red-400');
                }
            } else if (action === 'markpaid') {
                await markAsPaid(id);
            } else if (action === 'delete') {
                // Show confirmation modal
                document.getElementById('confirmDeleteBtn').dataset.id = id;
                openModal(document.getElementById('deleteConfirmModal'));
            } else if (action === 'view-message') {
                // Show message history
                const snap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, id));
                if (snap.exists()) {
                    const inv = snap.data();
                    document.getElementById('detailClientName').textContent  = inv.clientName;
                    document.getElementById('detailInvoiceAmount').textContent = `$${parseFloat(inv.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    const logs = inv.messageLog || [];
                    const logContainer = document.getElementById('messageLogContainer');
                    logContainer.innerHTML = '';
                    logs.slice().reverse().forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'mb-4';
                        div.innerHTML = `<p class="text-sm text-slate-500">Date Sent: <strong class="text-slate-800">${new Date(log.timestamp).toLocaleString()}</strong></p>
                                         <p class="text-sm text-slate-500">Method: <strong class="text-slate-800">${log.method}</strong></p>
                                         <div class="mt-2 p-4 bg-slate-50 rounded-md border text-sm text-slate-700">${log.content}</div>`;
                        logContainer.appendChild(div);
                    });
                    showView('messageDetailView');
                }
            }
        });

        // Delete confirmation handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            const id = document.getElementById('confirmDeleteBtn').dataset.id;
            if (!id) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/invoices`, id));
                closeModal(document.getElementById('deleteConfirmModal'));
                showToast('Invoice deleted.', 'trash-2', 'text-red-400');
            } catch (err) {
                console.error('Delete failed:', err);
                showToast('Failed to delete invoice.', 'alert-circle', 'text-red-400');
            }
        });

        // Cancel buttons close any modal
        document.querySelectorAll('.cancel-btn').forEach(btn =>
            btn.addEventListener('click', () => closeModal(btn.closest('.modal-backdrop'))));

        // Format phone input (simple version)
        (() => {
            const phone = document.getElementById('clientPhone');
            if (!phone) return;
            phone.setAttribute('inputmode', 'numeric');
            phone.setAttribute('autocomplete', 'tel');
            const format = (v) => {
                const digits = v.replace(/\D/g, '').slice(0, 10);
                let out = digits.slice(0,3);
                if (digits.length > 3) out += '-' + digits.slice(3,6);
                if (digits.length > 6) out += '-' + digits.slice(6);
                return out;
            };
            ['input','paste','blur'].forEach(ev =>
                phone.addEventListener(ev, () => phone.value = format(phone.value))
            );
            phone.value = format(phone.value);
        })();

        // Trigger due date set on page load
        setDefaultDueDate();


        
        // --- Event Handlers ---
        // View Pricing button
        if (viewPricingBtn) {
            viewPricingBtn.addEventListener('click', () => {
                showView('pricingView');
            });
        }

        // CRM Dashboard Event Handlers
        document.addEventListener('click', (e) => {
            // Back to billing button
            if (e.target.closest('.back-to-billing-btn')) {
                showView('billingView');
            }

            // Sync all invoices button
            if (e.target.closest('#syncAllInvoicesBtn')) {
                syncAllInvoicesToCrm();
            }

            // CRM tab buttons
            if (e.target.closest('.crm-tab-btn')) {
                const tabBtn = e.target.closest('.crm-tab-btn');
                const tabName = tabBtn.dataset.tab;
                
                // Update tab buttons
                document.querySelectorAll('.crm-tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                tabBtn.classList.add('active', 'border-indigo-500', 'text-indigo-600');
                tabBtn.classList.remove('border-transparent', 'text-gray-500');
                
                // Update tab content
                document.querySelectorAll('.crm-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + 'Tab').classList.remove('hidden');
            }
        });
        
        // --- Initial Load ---
        // Initialize Lucide icons when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                lucide.createIcons();
                // Suppress warnings on page load
                suppressWarnings();
                // Show usage meter by default
                if (usageMeter) {
                    usageMeter.classList.remove('hidden');
                }
                // Show guest invoices if no user is signed in
                if (!currentUserId) {
                    renderGuestInvoices();
                }
            });
        } else {
            lucide.createIcons();
            // Suppress warnings on page load
            suppressWarnings();
            // Show usage meter by default
            if (usageMeter) {
                usageMeter.classList.remove('hidden');
            }
            // Show guest invoices if no user is signed in
            if (!currentUserId) {
                renderGuestInvoices();
            }
        }
        
        // Ensure icons are properly loaded after a short delay
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
        
        // Also reinitialize icons when the page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                lucide.createIcons();
            }
        });
        
        // Force reinitialize icons for the header specifically
        setTimeout(() => {
            const headerIcons = document.querySelectorAll('header [data-lucide]');
            if (headerIcons.length > 0) {
                lucide.createIcons();
            }
        }, 200);
        
        // Additional initialization for gem icon specifically
        setTimeout(() => {
            const gemIcon = document.querySelector('[data-lucide="gem"]');
            if (gemIcon) {
                lucide.createIcons();
            }
        }, 500);
    </script>
</body>
</html>
